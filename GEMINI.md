# Calstar - 问天星算专业命理排盘系统

## Project Overview
Calstar (问天星算) 是一个高性能、单文件的本地网页程序，专为中国传统命理（八字、紫微斗数布局）设计。它集成了精确的历法转换、干支计算、时辰范围提醒以及 Markdown 报告导出功能，旨在提供一个纯净、无广告且完全离线的排盘环境。

### Key Technologies
- **UI Framework:** [Tailwind CSS](https://tailwindcss.com/) (Local v2.2.19) - 用于构建紧凑、现代的中式审美界面。
- **Core Engine:** [lunar-javascript](https://github.com/6678/lunar-javascript) (Local) - 提供精准的公农历转换、节气切分及干支逻辑。
- **Architecture:** 单文件原生 JS + 本地资源 (Vanilla JS, Local Assets)。
- **Styling:** 使用 Noto Serif SC 衬线体，营造典雅的阅读体验。

## Directory Overview
- `index.html`: 核心主程序骨架，负责 UI 布局与脚本挂载。
- `js/`: 模块化脚本目录。
  - `app.js`: UI 驱动与核心交互逻辑。
  - `astro.js`: AstroEngine 高精度星历引擎。
  - `bazi.js`: 八字命理核心推算逻辑。
  - `config.js`: 全局配置、字典与常量。
  - `geo.js`: 地理坐标、真太阳时与恒星时计算。
  - `data_city.js`: 全国三级经纬度地理数据库。
  - `ziwei.js`: 紫微斗数核心排盘引擎（十四主星、十二宫职、生年四化）。
- `css/style.css`: 自定义中式审美样式表。
- `lunar.js`: 离线版历法核心算法库（第三方）。
- `tailwind.min.css`: 离线版 Tailwind CSS 库。
- `GEMINI.md`: 本项目指令集与开发上下文。

## Key Features
1. **智能下拉输入:** 支持公历/农历一键切换，强制 YYYY-MM-DD 与 24 小时制，完全避开浏览器 AM/PM 干扰。
2. **高精度时间校正体系:** 
   - **真太阳时 (Bazi):** 针对八字排盘，内置三级经纬度数据库，支持基于经度差与均时差 (EOT) 的自动修正，确保时辰切分符合传统命理。
   - **绝对时刻 (Astronomy):** 上升星座与星历计算严格基于原始标准时间 (UTC)，避免了经度双重修正与 EOT 对天文几何位置的错误干扰。
3. **时辰边界提醒:** 实时计算当前时辰范围（如 11:00~13:00）并展示修正分钟数，方便进行精确排盘判断。
4. **实时排盘:** 所有输入项修改（年月日时分、性别、地点、修正开关）均会触发即时重绘。
5. **响应式架构:** 针对移动端采用 Tab 切换机制（命盘/报告），确保 4x4 井字布局在手机端完美展示并支持报告全屏阅读。
6. **全量专业术语简介:** 针对十神、纳音、星座、十四主星及八字/紫微双系统十二宫提供全量 Hover Tooltips。采用动态层级控制（z-index: 100+）与边缘溢出优化，确保简介在任何位置（含顶部和命盘中心）均不被遮挡。
7. **大运与交运时间:** 利用 `EightChar` 对象精确计算交运时间（如“出生后 x 年 x 月交运”），并排出 8 步大运（包含干支、起运年份、虚岁）。
8. **五行力量精算:** 自动统计八字原局五行个数，并明确标注“五行缺X”。
9. **神煞与三垣:** 自动推算年、月、日、时四柱核心神煞（如天乙贵人、桃花、华盖等）以及胎元、命宫、身宫。
10. **十二宫职映射:** 根据命宫位置，逆时针将十二宫职（命宫至父母宫）自动分配并渲染至四周的地支网格中。
11. **天文级占星校正:** 基于节气“中气”精准判定太阳星座（含边界星座 Cusp 提醒），并结合经纬度与地方恒星时（LST）推算上升星座。
12. **4x4 模块化 AI 报告系统:** 侧边栏实时生成结构化 Markdown 报告。支持 4 种风格与 4 种需求的 16 种自由组合。
13. **三方四正与大一统 AI 指令:** 自动组装紫微“三方四正”数据。采用“大一统 Prompt 架构”，动态合并专家身份与解盘逻辑集，支持多术合参（八字+紫微+占星）并保持序号连续。
14. **可选排盘种类:** 用户可自由勾选“八字”、“紫微”、“星座”的一种或多种组合。UI 界面与 AI 报告内容将根据勾选状态实时同步条件渲染。
15. **本地存储与 URL 持久化:** 自动记忆用户输入及排盘配置（含种类开关）。支持通过 URL Hash 直接分享特定配置的排盘结果。
16. **高精度星历引擎 (AstroEngine):** 基于 J2000.0 历元实现轻量级微型星历引擎，自主计算地心黄经。
17. **轻量级紫微斗数引擎:** 纯原生 JS 实现，支持精确计算十二宫职、十四主星、五行局及生年四化（禄权科忌）。
18. **子夜流派切换与日期同步:** 
    - 自动感知 23:00~24:00 (夜子时) 降生，动态弹出流派选择面板。
    - 支持“古法子初换日”与“保留夜子时”双轨逻辑切换。
    - 选择古法换日模式时，农历日期、年份及生肖将自动同步至下一天，实现算法与显示的逻辑闭环。
19. **高危时空 AI 预警:** 针对子夜交界降生，在 Markdown 报告中强制注入“时空预警”模块，锁定日柱干支并强化 AI 解盘指令，规避大模型对换日逻辑的认知偏见。

## Usage
### Running the Project
本项目不需要任何构建步骤。双击 `index.html` 即可在任何现代浏览器中运行。
- **环境要求:** 确保 `lunar.js`、`tailwind.min.css`、`js/` 目录及 `css/` 目录与 `index.html` 位于同一目录下。
- **真太阳时校对:** 输入公历时间后，观察中心区域显示的“时辰范围”，若输入时间接近边界，建议根据所在地经度进行增减校对。

### Development Conventions
- **离线优先:** 严禁引入外部 CDN 资源，所有依赖必须保持本地化。
- **模块化架构:** 保持逻辑解耦，新增功能需按职责放入 `js/` 目录下相应的模块中。
- **样式规范:** 优先使用 Tailwind Utility Classes，特定中式样式定义在 `css/style.css` 中。
- **数据结构:** 使用 `localStorage` (key: `bazi_last_input`) 存储用户输入状态。

## Future TODOs
- [ ] 增加详细的流年、流月排盘解析。
- [ ] 增加各宫位（子平格局）的初步解析逻辑。
- [ ] 优化移动端的触摸滑动交互体验。
