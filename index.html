<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>问天星算 - 专业命理排盘</title>
    <link rel="stylesheet" href="tailwind.min.css">
    <script src="lunar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Noto Serif SC", "Source Han Serif SC", "Source Han Serif CN", "Songti SC", "STSong", "SimSun", serif; background-color: #F5F5DC; color: #2C3E50; -webkit-tap-highlight-color: transparent; }
        .chinese-border { border: 1px solid #8B4513; position: relative; }
        .chinese-border::after { content: ''; position: absolute; top: 1px; left: 1px; right: 1px; bottom: 1px; border: 1px solid #8B4513; pointer-events: none; }
        .palace-cell { transition: all 0.3s ease; min-width: 0; }
        .palace-cell:hover { background-color: #E9E9D0; }
        .color-wood { color: #2D5A27; } .color-fire { color: #C04851; } .color-earth { color: #8B7042; } .color-metal { color: #9D9087; } .color-water { color: #1A1A1A; }
        .pillar-highlight { border-bottom: 2px solid #C04851; }
        
        [data-tip] { position: relative; cursor: help; }
        [data-tip]:hover::after {
            content: attr(data-tip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            padding: 6px 10px; background-color: #FFFDE7 !important; color: #5D4037 !important; font-size: 10px; white-space: pre-wrap;
            width: 150px; border: 1px solid #8B4513; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999; line-height: 1.5; font-weight: normal; opacity: 1 !important; visibility: visible; text-align: left;
        }

        /* 响应式显示控制 */
        .tab-content { display: none; }
        .tab-content.active-grid { display: grid; }
        .tab-content.active-flex { display: flex; }

        @media (max-width: 768px) {
            .palace-cell { aspect-ratio: 1 / 1.1; padding: 2px !important; }
            .palace-cell span.text-lg { font-size: 1rem !important; }
            .center-info { padding: 4px !important; }
            #baziDisplay span.text-xl { font-size: 1.125rem !important; }
            #baziDisplay .text-[9px], #baziDisplay .text-[8px] { font-size: 7px !important; transform: scale(0.9); }
            #shichenInfo { font-size: 8px !important; line-height: 1; }
            .sc-btn { padding: 2px 4px !important; font-size: 8px !important; }
        }
    </style>
</head>
<body class="p-1 md:p-4 md:h-screen md:overflow-hidden flex flex-col">
    <div class="max-w-6xl mx-auto flex-grow flex flex-col w-full h-full min-h-0">
        <header class="text-center mb-1 md:mb-2">
            <h1 class="text-lg md:text-2xl font-bold text-yellow-900">问天星算</h1>
        </header>

        <!-- 输入模块 -->
        <section class="bg-white bg-opacity-50 p-2 rounded shadow-sm border border-yellow-200 mb-2 shrink-0">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 items-end">
                <div class="col-span-1">
                    <div class="flex justify-between items-center mb-0.5">
                        <label class="block text-[10px] font-bold text-yellow-900">日期</label>
                        <div class="flex items-center space-x-1 text-[8px] md:text-[9px] text-yellow-700">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="calType" value="solar" checked class="mr-0.5">公</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="calType" value="lunar" class="mr-0.5">农</label>
                        </div>
                    </div>
                    <div class="flex items-center space-x-0.5 border-b border-yellow-900">
                        <select id="inputYear" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">-</span>
                        <select id="inputMonth" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">-</span>
                        <select id="inputDay" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                    </div>
                </div>
                <div class="col-span-1">
                    <div class="flex justify-between items-center mb-0.5">
                        <label class="block text-[10px] font-bold text-yellow-900">时间</label>
                        <label class="flex items-center text-[10px] cursor-pointer text-yellow-700">
                            <input type="checkbox" id="timeUnknown" class="mr-1 scale-75">不详
                        </label>
                    </div>
                    <div id="timeInputGroup" class="flex items-center space-x-0.5 border-b border-yellow-900">
                        <select id="inputHour" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">:</span>
                        <select id="inputMin" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                    </div>
                </div>
                <div class="col-span-1">
                    <label class="block text-[10px] font-bold text-yellow-900 mb-0.5">性别</label>
                    <div class="flex space-x-2 text-[11px] md:text-xs py-0.5">
                        <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="1" checked class="mr-0.5">男</label>
                        <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="0" class="mr-0.5">女</label>
                    </div>
                </div>
                <div class="col-span-1">
                    <button id="btnCalculate" class="w-full bg-yellow-900 text-white py-1 rounded text-xs hover:bg-yellow-800 transition">重绘</button>
                </div>
            </div>
            <div id="shichenGrid" class="flex flex-wrap gap-1 mt-1.5 border-t border-yellow-100 pt-1.5"></div>
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1.5 border-t border-yellow-100 pt-1.5">
                <div class="flex items-center space-x-1">
                    <select id="provinceSel" class="bg-transparent text-[10px] border-b border-yellow-900 focus:outline-none cursor-pointer"></select>
                    <select id="citySel" class="bg-transparent text-[10px] border-b border-yellow-900 focus:outline-none cursor-pointer"></select>
                    <span id="lngDisplay" class="text-[8px] text-yellow-700 opacity-60"></span>
                </div>
                <div id="shichenInfo" class="text-[9px] text-red-800 opacity-80 font-mono"></div>
                <label class="flex items-center text-[10px] cursor-pointer text-red-900 font-bold ml-auto">
                    <input type="checkbox" id="useSolarTime" class="mr-1 scale-75">真太阳时
                </label>
            </div>
        </section>

        <!-- 移动端 Tab -->
        <div class="flex md:hidden border-b border-yellow-200 mb-2 shrink-0">
            <button onclick="switchTab('chart')" id="tabBtn-chart" class="flex-1 py-2 text-xs font-bold border-b-2 border-yellow-900 text-yellow-900">命盘网格</button>
            <button onclick="switchTab('report')" id="tabBtn-report" class="flex-1 py-2 text-xs font-bold border-b-2 border-transparent text-gray-400">文字报告</button>
        </div>

        <!-- 主体 -->
        <div class="flex flex-col md:flex-row gap-2 md:gap-4 flex-grow overflow-hidden min-h-0">
            <div id="tab-chart" class="tab-content active-grid flex-grow grid grid-cols-4 grid-rows-4 gap-1 md:gap-2 h-full">
                <div id="pos-5" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-6" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-7" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-8" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-4" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div class="col-span-2 row-span-2 bg-white bg-opacity-80 chinese-border p-1 md:p-2 center-info flex flex-col items-center justify-center text-center overflow-hidden">
                    <div id="basicInfo" class="space-y-0.5 w-full"></div>
                    <div id="shichenInfo" class="text-[8px] md:text-[10px] text-red-800 opacity-70 mt-0.5 mb-0.5 font-mono"></div>
                    <div id="baziDisplay" class="mt-1 flex space-x-0.5 md:space-x-2 border-t border-yellow-100 pt-1 w-full justify-around min-h-[45px] md:min-h-[60px]"></div>
                </div>
                <div id="pos-9" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-3" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-10" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-2" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-1" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-0" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-11" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
            </div>

            <div id="tab-report" class="tab-content md:active-flex w-full md:w-80 flex-col shrink-0 border-l-0 md:border-l border-yellow-200 md:pl-4 h-full hidden overflow-hidden">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[10px] font-bold text-yellow-900">Markdown 报告</label>
                    <button onclick="copyMd()" id="copyBtn" class="bg-yellow-100 text-yellow-900 px-2 py-0.5 rounded text-[10px]">复制</button>
                </div>
                <textarea id="mdOutput" readonly class="flex-grow bg-white bg-opacity-50 border border-yellow-200 rounded p-2 text-[10px] font-mono focus:outline-none resize-none leading-relaxed overflow-y-auto"></textarea>
            </div>
        </div>
    </div>

    <script>
        const WUXING = { '甲': 'wood', '乙': 'wood', '寅': 'wood', '卯': 'wood', '丙': 'fire', '丁': 'fire', '巳': 'fire', '午': 'fire', '戊': 'earth', '己': 'earth', '辰': 'earth', '戌': 'earth', '丑': 'earth', '未': 'earth', '庚': 'metal', '辛': 'metal', '申': 'metal', '酉': 'metal', '壬': 'water', '癸': 'water', '亥': 'water', '子': 'water' };
        const BRANCHES = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
        const ZODIAC_SIGNS = ["白羊", "金牛", "双子", "巨蟹", "狮子", "处女", "天秤", "天蝎", "射手", "摩羯", "水瓶", "双鱼"];
        const LUNAR_MONTHS = ["正月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "冬月", "腊月"];
        const LUNAR_DAYS = ["初一", "初二", "初三", "初四", "初五", "初六", "初七", "初八", "初九", "初十", "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十", "廿一", "廿2", "廿三", "廿四", "廿五", "廿六", "廿七", "廿八", "廿九", "三十"];
        const TERM_DICT = { '比肩': '同我者为比肩。\n\n代表竞争、朋友、独立性。', '劫财': '同我而异性者为劫财。\n\n代表破财、竞争、感情用事。', '食神': '我生者为食神。\n\n代表福气、口才、才华、温和。', '伤官': '我生而异性者为伤官。\n\n代表才华、叛逆、变动、傲气。', '正财': '我克者为正财。\n\n代表薪资、现实、稳重、占有欲。', '偏财': '我克而异性者为偏财。\n\n代表横财、慷慨、投机、多情。', '正官': '克我者为正官。\n\n代表地位、名誉、纪律、自我约束。', '七杀': '克我而异性者为七杀。\n\n代表权力、压力、勇气、竞争。', '偏印': '生我者为偏印。\n\n代表直觉、艺术、孤僻、领悟力。', '正印': '生我而异性者为正印。\n\n代表学识、慈悲、保护、名誉。', '日主': '出生日的天干，代表命主本人。', '海中金': '深藏不露。\n\n代表含蓄深沉。', '炉中火': '热烈旺盛。\n\n代表热情果断。', '大林木': '枝繁叶茂。\n\n代表仁慈正直。', '路旁土': '踏实平稳。\n\n代表稳重厚道。', '剑锋金': '锐利决断。\n\n代表刚强锐气。', '山头火': '火势极高。\n\n代表威严急躁。', '涧下水': '清澈细流。\n\n代表柔和耐心。', '城头土': '守卫之土。\n\n代表忠诚保守。', '白蜡金': '纯洁易塑。\n\n代表柔弱灵性。', '杨柳木': '柔顺多变。\n\n代表灵活适应。', '泉中水': '源头活水。\n\n代表睿智温和。', '屋上土': '遮风挡雨。\n\n代表责任孤独。', '霹雳火': '爆发威猛。\n\n代表正直爆发。', '松柏木': '坚韧不拔。\n\n代表长寿孤高。', '长流水': '滔滔不绝。\n\n代表远见奔波。', '沙中金': '去伪存真。\n\n代表坚韧细致。', '山下火': '渐趋平缓。\n\n代表谦虚内敛。', '平地木': '根基深厚。\n\n代表朴实担当。', '壁上土': '依附依靠。\n\n代表忠厚规矩。', '金箔金': '华而不实。\n\n代表细腻艺术。', '佛灯火': '照亮黑暗。\n\n代表仁慈孤独。', '天河水': '滋润万物。\n\n代表博大恩泽。', '大驿土': '坦荡宽阔。\n\n代表胸怀诚信。', '钗钏金': '精巧华丽。\n\n代表高贵细腻。', '桑柘木': '奉献勤劳。\n\n代表柔顺奉献。', '大溪水': '奔腾不息。\n\n代表活力雄心。', '沙中土': '松散多变。\n\n代表随和宽容。', '天上火': '光明磊落。\n\n代表博大公正。', '石榴木': '多才多艺。\n\n代表多才性格。', '大海水': '浩瀚无垠。\n\n代表宽广包容。' };

        const CITY_DATA = { "北京市": {"北京市": [116.40, 39.90]}, "上海市": {"上海市": [121.47, 31.23]}, "天津市": {"天津市": [117.20, 39.12]}, "重庆市": {"重庆市": [106.50, 29.53]}, "广东省": {"广州市": [113.23, 23.16], "深圳市": [114.07, 22.62], "珠海市": [113.52, 22.30], "东莞市": [113.75, 23.04], "中山市": [113.38, 22.52]}, "浙江省": {"杭州市": [120.19, 30.26], "宁波市": [121.56, 29.86], "温州市": [120.67, 28.00]}, "江苏省": {"南京市": [118.78, 32.04], "苏州市": [120.62, 31.32], "无锡市": [120.29, 31.59]}, "四川省": {"成都市": [104.06, 30.67]}, "吉林省": {"通化市": [125.93, 41.73]} };

        function getEOT(doy) { const b = (2 * Math.PI * (doy - 81)) / 365; return 9.87 * Math.sin(2 * b) - 7.53 * Math.cos(b) - 1.5 * Math.sin(b); }
        function getSolarTimeOffset(lng, y, m, d) {
            const longOff = (lng - 120.0) * 4;
            const date = new Date(y, m - 1, d);
            const start = new Date(y, 0, 0);
            const doy = Math.floor((date - start) / 86400000);
            const eotOff = getEOT(doy);
            return { total: longOff + eotOff, longOff, eotOff };
        }

        function getAscendant(year, month, day, hh, mm, lng, lat) {
            const date = new Date(Date.UTC(year, month - 1, day, hh, mm));
            const jd = (date.getTime() / 86400000) + 2440587.5;
            const t = (jd - 2451545.0) / 36525.0;
            let gmst = 6.697374558 + 0.06570982441908 * (jd - 2451545.0) + 1.00273790935 * (hh + mm / 60);
            gmst = gmst % 24; if (gmst < 0) gmst += 24;
            let lst = gmst + lng / 15;
            lst = lst % 24; if (lst < 0) lst += 24;
            const ram = lst * 15 * Math.PI / 180;
            const eps = (23.4393 - 0.013 * t) * Math.PI / 180;
            const phi = lat * Math.PI / 180;
            let asc = Math.atan2(-Math.cos(ram), Math.sin(ram) * Math.cos(eps) + Math.tan(phi) * Math.sin(eps));
            asc = asc * 180 / Math.PI; if (asc < 0) asc += 360;
            return ZODIAC_SIGNS[Math.floor(asc / 30)];
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active-grid', 'active-flex'));
            const target = document.getElementById('tab-' + tabId);
            if (tabId === 'chart') target.classList.add('active-grid');
            else target.classList.add('active-flex');
            
            document.querySelectorAll('[id^="tabBtn-"]').forEach(b => b.classList.remove('border-yellow-900', 'text-yellow-900'));
            document.querySelectorAll('[id^="tabBtn-"]').forEach(b => b.classList.add('border-transparent', 'text-gray-400'));
            document.getElementById('tabBtn-' + tabId).classList.add('border-yellow-900', 'text-yellow-900');
            document.getElementById('tabBtn-' + tabId).classList.remove('border-transparent', 'text-gray-400');
        }

        window.onload = function() {
            const lastData = JSON.parse(localStorage.getItem('bazi_last_input')) || {};
            const now = new Date();
            const defY = lastData.y || now.getFullYear(), defM = lastData.m || (now.getMonth() + 1), defD = lastData.d || now.getDate();
            const defH = lastData.hh !== undefined ? lastData.hh : now.getHours(), defMin = lastData.mm !== undefined ? lastData.mm : now.getMinutes();
            const defGen = lastData.gender || "1", defUnk = lastData.unknown || false, defCal = lastData.cal || "solar";
            const defProv = lastData.province || "北京市", defCity = lastData.city || "北京市", defUseSolar = lastData.useSolar || false;

            const yearSel = document.getElementById('inputYear'), monthSel = document.getElementById('inputMonth'), daySel = document.getElementById('inputDay');
            const hourSel = document.getElementById('inputHour'), minSel = document.getElementById('inputMin');
            const unkCheck = document.getElementById('timeUnknown'), provSel = document.getElementById('provinceSel'), citySel = document.getElementById('citySel'), solarCheck = document.getElementById('useSolarTime');

            for(let i=1900; i<=2100; i++) yearSel.add(new Option(i + '年', i, i===defY, i===defY));
            for(let i=0; i<24; i++) hourSel.add(new Option(String(i).padStart(2, '0') + '时', i, i===defH, i===defH));
            for(let i=0; i<60; i++) minSel.add(new Option(String(i).padStart(2, '0') + '分', i, i===defMin, i===defMin));
            Object.keys(CITY_DATA).forEach(p => provSel.add(new Option(p, p, p===defProv, p===defProv)));

            function getCalType() { return document.querySelector('input[name="calType"]:checked').value; }
            function updateCityOptions() { citySel.innerHTML = ''; const p = provSel.value; Object.keys(CITY_DATA[p]).forEach(c => citySel.add(new Option(c, c, c===defCity, c===defCity))); }
            function updateDayOptions() {
                const y = parseInt(yearSel.value), type = getCalType(); monthSel.innerHTML = ''; daySel.innerHTML = '';
                if (type === 'solar') {
                    for(let i=1; i<=12; i++) monthSel.add(new Option(String(i).padStart(2, '0') + '月', i, i===defM, i===defM));
                    const last = new Date(y, parseInt(monthSel.value), 0).getDate();
                    for(let i=1; i<=last; i++) daySel.add(new Option(String(i).padStart(2, '0') + '日', i, i===Math.min(defD, last), i===Math.min(defD, last)));
                } else {
                    const months = LunarYear.fromYear(y).getMonths();
                    months.forEach(m => monthSel.add(new Option(m.isLeap() ? "闰" + LUNAR_MONTHS[m.getMonth()-1] : LUNAR_MONTHS[m.getMonth()-1], m.getMonth() * (m.isLeap() ? -1 : 1))));
                    const mVal = parseInt(monthSel.value); const m = months.find(mm => mm.getMonth() === Math.abs(mVal) && mm.isLeap() === (mVal < 0)) || months[0];
                    for(let i=1; i<=m.getDayCount(); i++) daySel.add(new Option(LUNAR_DAYS[i-1], i));
                }
            }

            document.querySelectorAll('input[name="calType"]').forEach(r => r.onchange = () => { updateDayOptions(); updateDisplay(); });
            yearSel.onchange = () => { updateDayOptions(); updateDisplay(); };
            monthSel.onchange = () => { updateDisplay(); };
            daySel.onchange = updateDisplay; hourSel.onchange = updateDisplay; minSel.onchange = updateDisplay;
            provSel.onchange = () => { updateCityOptions(); updateDisplay(); };
            citySel.onchange = updateDisplay; solarCheck.onchange = updateDisplay;
            unkCheck.onchange = () => { document.getElementById('timeInputGroup').style.opacity = unkCheck.checked ? "0.3" : "1"; updateDisplay(); };

            const shichenGrid = document.getElementById('shichenGrid');
            BRANCHES.forEach((b, i) => {
                const btn = document.createElement('button'); btn.innerText = b + '时';
                btn.className = "px-2 py-0.5 text-[9px] border border-yellow-300 rounded hover:bg-yellow-100 transition sc-btn";
                btn.onclick = () => { unkCheck.checked = false; hourSel.value = (i * 2 + 23) % 24; minSel.value = 0; updateDisplay(); };
                shichenGrid.appendChild(btn);
            });

            updateCityOptions(); updateDayOptions(); 
            document.querySelector(`input[name="calType"][value="${defCal}"]`).checked = true;
            unkCheck.checked = defUnk; solarCheck.checked = defUseSolar;
            document.getElementById('timeInputGroup').style.opacity = defUnk ? "0.3" : "1";
            document.querySelector(`input[name="gender"][value="${defGen}"]`).checked = true;
            document.getElementById('btnCalculate').onclick = updateDisplay;
            updateDisplay();
        };

        function getWuXingClass(char) { return `color-${WUXING[char] || 'metal'}`; }

        function renderPillar(title, gan, zhi, hide, ssGan, ssZhi, nayin, isDM = false) {
            const tipGan = TERM_DICT[ssGan] || ''; const tipZhi = TERM_DICT[ssZhi] || ''; const tipNaYin = TERM_DICT[nayin] || '';
            return `<div class="flex flex-col items-center ${isDM ? 'pillar-highlight' : ''}">
                    <span class="text-[8px] md:text-[10px] text-red-700 font-bold mb-0.5" ${tipGan ? `data-tip="${ssGan}: ${tipGan}"` : ''}>${ssGan||''}</span>
                    <span class="text-[8px] md:text-[10px] text-yellow-800">${title}</span>
                    <span class="text-base md:text-xl font-bold ${getWuXingClass(gan)}">${gan}</span>
                    <span class="text-base md:text-xl font-bold ${getWuXingClass(zhi)}">${zhi}</span>
                    <div class="flex flex-col items-center leading-none mt-0.5">
                        <span style="color: rgba(44,62,80,0.4)" class="text-[7px] md:text-[9px]">${hide||''}</span>
                        <span style="color: rgba(192,72,81,0.6)" class="text-[7px] md:text-[8px] scale-90" ${tipZhi ? `data-tip="${ssZhi}: ${tipZhi}"` : ''}>${ssZhi||''}</span>
                        <span style="color: rgba(139,69,19,0.5)" class="text-[7px] md:text-[8px] mt-0.5 scale-90 whitespace-nowrap" ${tipNaYin ? `data-tip="${nayin}: ${tipNaYin}"` : ''}>${nayin||''}</span>
                    </div>
                </div>`;
        }

        function updateDisplay() {
            try {
                const y = parseInt(document.getElementById('inputYear').value), m = parseInt(document.getElementById('inputMonth').value), d = parseInt(document.getElementById('inputDay').value);
                const hh = parseInt(document.getElementById('inputHour').value), mm = parseInt(document.getElementById('inputMin').value);
                const type = document.querySelector('input[name="calType"]:checked').value;
                const gen = document.querySelector('input[name="gender"]:checked').value, unk = document.getElementById('timeUnknown').checked;
                const prov = document.getElementById('provinceSel').value, city = document.getElementById('citySel').value, useSolar = document.getElementById('useSolarTime').checked;
                localStorage.setItem('bazi_last_input', JSON.stringify({ y, m, d, hh, mm, gender: gen, unknown: unk, province: prov, city, useSolar, cal: type }));

                let solar;
                if (type === 'solar') solar = Solar.fromYmdHms(y, m, d, hh, mm, 0);
                else { const lunar = Lunar.fromYmd(y, Math.abs(m), d); if (m < 0) lunar.setLeap(true); solar = lunar.getSolar(); solar = Solar.fromYmdHms(solar.getYear(), solar.getMonth(), solar.getDay(), hh, mm, 0); }

                const [lng, lat] = CITY_DATA[prov][city];
                document.getElementById('lngDisplay').innerText = `(${lng},${lat})`;
                const off = getSolarTimeOffset(lng, solar.getYear(), solar.getMonth(), solar.getDay());
                let cSol = solar;
                if (useSolar && !unk) {
                    const cD = new Date(new Date(solar.getYear(), solar.getMonth()-1, solar.getDay(), hh, mm).getTime() + off.total * 60000);
                    cSol = Solar.fromYmdHms(cD.getFullYear(), cD.getMonth()+1, cD.getDate(), cD.getHours(), cD.getMinutes(), 0);
                }
                const lunar = Lunar.fromSolar(cSol), baZi = lunar.getEightChar();
                const asc = unk ? "?" : getAscendant(cSol.getYear(), cSol.getMonth(), cSol.getDay(), cSol.getHour(), cSol.getMinute(), lng, lat);

                if (!unk) {
                    let st = cSol.getHour() % 2 === 0 ? cSol.getHour() - 1 : cSol.getHour(); if (st === -1) st = 23;
                    document.getElementById('shichenInfo').innerHTML = `时辰:${String(st).padStart(2, '0')}:00~${String((st+2)%24).padStart(2, '0')}:00 | 修正:${off.total.toFixed(1)}分`;
                    document.querySelectorAll('.sc-btn').forEach(btn => btn.innerText.startsWith(baZi.getTimeZhi()) ? btn.classList.add('bg-yellow-700', 'text-white') : btn.classList.remove('bg-yellow-700', 'text-white'));
                } else { document.getElementById('shichenInfo').innerText = "出生时辰不详"; }

                document.getElementById('basicInfo').innerHTML = `
                    <div class="text-[12px] md:text-[13px] font-bold">${cSol.toYmd()} ${unk ? '' : String(cSol.getHour()).padStart(2, '0')+':'+String(cSol.getMinute()).padStart(2, '0')}</div>
                    <div class="text-[10px] md:text-[11px] text-yellow-900">${lunar.getMonthInChinese()}月 ${lunar.getDayInChinese()} ${unk ? '' : '('+baZi.getTimeZhi()+'时)'}</div>
                    <div class="flex flex-wrap justify-center gap-x-1 text-[8px] md:text-[9px] mt-0.5 opacity-80">
                        <span>${lunar.getYearShengXiao()}</span>
                        <span class="cursor-help" data-tip="太阳星座：主基本性格。">${cSol.getXingZuo()}座</span>
                        <span class="text-red-800 font-bold cursor-help" data-tip="上升星座：主外在印象。">(${asc})</span>
                    </div>`;
                
                document.getElementById('baziDisplay').innerHTML = `${renderPillar('年', baZi.getYearGan(), baZi.getYearZhi(), baZi.getYearHideGan().join(''), baZi.getYearShiShenGan(), baZi.getYearShiShenZhi()[0], lunar.getYearNaYin())}${renderPillar('月', baZi.getMonthGan(), baZi.getMonthZhi(), baZi.getMonthHideGan().join(''), baZi.getMonthShiShenGan(), baZi.getMonthShiShenZhi()[0], lunar.getMonthNaYin())}${renderPillar('日', baZi.getDayGan(), baZi.getDayZhi(), baZi.getDayHideGan().join(''), '日主', baZi.getDayShiShenZhi()[0], lunar.getDayNaYin(), true)}${unk ? '<div class="flex flex-col items-center opacity-20"><span class="text-[9px] text-yellow-800">时</span><span class="text-xl font-bold text-gray-300">?</span></div>' : renderPillar('时', baZi.getTimeGan(), baZi.getTimeZhi(), baZi.getTimeHideGan().join(''), baZi.getTimeShiShenGan(), baZi.getTimeShiShenZhi()[0], lunar.getTimeNaYin())}`;

                BRANCHES.forEach((branch, index) => {
                    const cell = document.getElementById(`pos-${index}`);
                    const isT = !unk && baZi.getTimeZhi() === branch, isY = baZi.getYearZhi() === branch;
                    cell.innerHTML = `<div class="flex justify-between items-start"><span class="text-base font-bold ${getWuXingClass(branch)}">${branch}</span><div class="flex flex-col items-end">${isT?'<span class="bg-red-700 text-white text-[7px] px-0.5 rounded">时</span>':''}${isY?'<span class="bg-yellow-700 text-white text-[7px] px-0.5 rounded">年</span>':''}</div></div><div class="text-[8px] text-yellow-900 opacity-20 text-right">${branch}宫</div>`;
                    cell.style.backgroundColor = isT ? "rgba(254, 243, 199, 0.8)" : "";
                });

                const mdText = `### 问天星算排盘报告\n\n- **公历**: ${cSol.toYmd()} ${unk ? '不详' : String(cSol.getHour()).padStart(2, '0')+':'+String(cSol.getMinute()).padStart(2, '0')}\n- **地点**: ${prov}-${city} (${lng}, ${lat})\n- **农历**: ${lunar.getYearInChinese()}年 ${lunar.getMonthInChinese()}月 ${lunar.getDayInChinese()}\n- **${unk?'六字':'八字'}**: ${baZi.getYearGan()}${baZi.getYearZhi()}年 ${baZi.getMonthGan()}${baZi.getMonthZhi()}月 ${baZi.getDayGan()}${baZi.getDayZhi()}日${unk?'':' '+baZi.getTimeGan()+baZi.getTimeZhi()+'时'}\n- **太阳星座**: ${cSol.getXingZuo()}座 / **上升星座**: ${asc}座\n- **真太阳时修正**: ${off.total.toFixed(2)} 分钟\n- **性别**: ${gen==='1'?'男':'女'} / **生肖**: ${lunar.getYearShengXiao()} (${lunar.getYearNaYin()})\n\n#### 生辰八字 (${unk?'六字' : '八字'})\n| 四柱 | 年柱 | 月柱 | 日柱 | 时柱 |\n| :--- | :--- | :--- | :--- | :--- |\n| **十神** | ${baZi.getYearShiShenGan()} | ${baZi.getMonthShiShenGan()} | 日主 | ${unk?'?':baZi.getTimeShiShenGan()} |\n| **干支** | ${baZi.getYearGan()}${baZi.getYearZhi()} | ${baZi.getMonthGan()}${baZi.getMonthZhi()} | ${baZi.getDayGan()}${baZi.getDayZhi()} | ${unk?'??':baZi.getTimeGan()+baZi.getTimeZhi()} |\n| **地势** | ${baZi.getYearShiShenZhi()[0]} | ${baZi.getMonthShiShenZhi()[0]} | ${baZi.getDayShiShenZhi()[0]} | ${unk?'?':baZi.getTimeShiShenZhi()[0]} |\n| **纳音** | ${lunar.getYearNaYin()} | ${lunar.getMonthNaYin()} | ${lunar.getDayNaYin()} | ${unk?'?':lunar.getTimeNaYin()} |\n| **藏干** | ${baZi.getYearHideGan().join('')} | ${baZi.getMonthHideGan().join('')} | ${baZi.getDayHideGan().join('')} | ${unk?'?':baZi.getTimeHideGan().join('')} |\n\n---\n*报告由问天星算生成，${useSolar?'已应用真太阳时修正':'未应用修正'}*`;
                document.getElementById('mdOutput').value = mdText;
            } catch (e) { console.error(e); }
        }
        function copyMd() { const area = document.getElementById('mdOutput'); const btn = document.getElementById('copyBtn'); area.select(); document.execCommand('copy'); btn.innerText = '已复制'; setTimeout(() => { btn.innerText = '复制'; }, 1500); }
    </script>
</body>
</html>
