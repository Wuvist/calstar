<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—®å¤©æ˜Ÿç®— - ä¸“ä¸šå‘½ç†æ’ç›˜</title>
    <link rel="stylesheet" href="tailwind.min.css">
    <script src="lunar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Noto Serif SC", "Source Han Serif SC", "Source Han Serif CN", "Songti SC", "STSong", "SimSun", serif; background-color: #F5F5DC; color: #2C3E50; -webkit-tap-highlight-color: transparent; font-size: 13px; }
        .chinese-border { border: 1px solid #8B4513; position: relative; }
        .chinese-border::after { content: ''; position: absolute; top: 1px; left: 1px; right: 1px; bottom: 1px; border: 1px solid #8B4513; pointer-events: none; z-index: -1; }
        .palace-cell { transition: all 0.3s ease; min-width: 0; overflow: visible !important; }
        .palace-cell:hover { background-color: #E9E9D0; }
        .color-wood { color: #2D5A27; } .color-fire { color: #C04851; } .color-earth { color: #8B7042; } .color-metal { color: #9D9087; } .color-water { color: #1A1A1A; }
        .pillar-highlight { border-bottom: 2px solid #C04851; }
        
        /* Tooltip åŸºç¡€æ ·å¼ */
        [data-tip] { position: relative; cursor: help; z-index: 10; }
        [data-tip]:hover::after {
            content: attr(data-tip); position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
            padding: 6px 10px; background-color: #FFFDE7 !important; color: #5D4037 !important; font-size: 10px; white-space: pre-wrap;
            width: 150px; border: 1px solid #8B4513; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999; line-height: 1.5; font-weight: normal; opacity: 1 !important; visibility: visible; text-align: left;
        }
        
        @media (max-width: 768px) {
            .center-info, #baziDisplay, #basicInfo { overflow: visible !important; }
            .tab-content { display: none !important; }
            .tab-content.active-grid { display: grid !important; }
            .tab-content.active-flex { display: flex !important; }
            
            .palace-cell { aspect-ratio: 1 / 1.1; padding: 2px !important; }
            .palace-cell span.text-lg { font-size: 1rem !important; }
            .center-info { padding: 4px !important; }
            #basicInfo, #baziDisplay { transform: scale(0.9); transform-origin: center top; width: 100%; }
            #baziDisplay span.text-xl { font-size: 1rem !important; }
            #baziDisplay .text-[9px], #baziDisplay .text-[8px] { font-size: 7px !important; transform: scale(0.9); }
            #shichenInfo { font-size: 8px !important; line-height: 1; }
            .sc-btn { padding: 2px 4px !important; font-size: 8px !important; }
        }
    </style>
</head>
<body class="p-1 md:p-4 h-screen overflow-hidden flex flex-col">
    <div class="max-w-6xl mx-auto flex-grow flex flex-col w-full h-full min-h-0">
        <header class="text-center mb-1 shrink-0">
            <h1 class="text-lg md:text-2xl font-bold text-yellow-900">é—®å¤©æ˜Ÿç®—</h1>
        </header>

        <section class="bg-white bg-opacity-50 p-2 rounded shadow-sm border border-yellow-200 mb-1 md:mb-4 shrink-0">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 items-end">
                <div class="col-span-1">
                    <div class="flex justify-between items-center mb-0.5">
                        <label class="block text-[10px] font-bold text-yellow-900">æ—¥æœŸ</label>
                        <div class="flex items-center space-x-1 text-[8px] md:text-[9px] text-yellow-700">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="calType" value="solar" checked class="mr-0.5">å…¬</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="calType" value="lunar" class="mr-0.5">å†œ</label>
                        </div>
                    </div>
                    <div class="flex items-center space-x-0.5 border-b border-yellow-900">
                        <select id="inputYear" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">-</span>
                        <select id="inputMonth" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">-</span>
                        <select id="inputDay" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                    </div>
                </div>
                <div class="col-span-1">
                    <div class="flex justify-between items-center mb-0.5">
                        <label class="block text-[10px] font-bold text-yellow-900">æ—¶é—´</label>
                        <label class="flex items-center text-[10px] cursor-pointer text-yellow-700">
                            <input type="checkbox" id="timeUnknown" class="mr-1 scale-75">ä¸è¯¦
                        </label>
                    </div>
                    <div id="timeInputGroup" class="flex items-center space-x-0.5 border-b border-yellow-900">
                        <select id="inputHour" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">:</span>
                        <select id="inputMin" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                    </div>
                </div>
                <div class="col-span-1">
                    <label class="block text-[10px] font-bold text-yellow-900 mb-0.5">æ€§åˆ«</label>
                    <div class="flex space-x-2 text-[11px] md:text-xs py-0.5">
                        <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="1" checked class="mr-0.5">ç”·</label>
                        <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="0" class="mr-0.5">å¥³</label>
                    </div>
                </div>
                <div class="col-span-1">
                    <button id="btnCalculate" class="w-full bg-yellow-900 text-white py-1 rounded text-xs hover:bg-yellow-800 transition">é‡ç»˜</button>
                </div>
            </div>
            <div id="shichenGrid" class="flex flex-wrap gap-1 mt-1.5 border-t border-yellow-100 pt-1.5"></div>
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1.5 border-t border-yellow-100 pt-1.5">
                <div class="flex items-center space-x-1">
                    <select id="provinceSel" class="bg-transparent text-[10px] border-b border-yellow-900 focus:outline-none cursor-pointer"></select>
                    <select id="citySel" class="bg-transparent text-[10px] border-b border-yellow-900 focus:outline-none cursor-pointer"></select>
                    <span id="lngDisplay" class="text-[8px] text-yellow-700 opacity-60"></span>
                </div>
                <div id="shichenInfo" class="text-[9px] text-red-800 opacity-80 font-mono"></div>
                <label class="flex items-center text-[10px] cursor-pointer text-red-900 font-bold ml-auto">
                    <input type="checkbox" id="useSolarTime" class="mr-1 scale-75">çœŸå¤ªé˜³æ—¶
                </label>
            </div>
        </section>

        <div class="flex md:hidden border-b border-yellow-200 mb-2 shrink-0">
            <button onclick="switchTab('chart')" id="tabBtn-chart" class="flex-1 py-2 text-xs font-bold border-b-2 border-yellow-900 text-yellow-900">å‘½ç›˜ç½‘æ ¼</button>
            <button onclick="switchTab('report')" id="tabBtn-report" class="flex-1 py-2 text-xs font-bold border-b-2 border-transparent text-gray-400">æ–‡å­—æŠ¥å‘Š</button>
        </div>

        <div class="flex flex-col md:flex-row gap-2 md:gap-4 flex-grow overflow-hidden min-h-0">
            <div id="tab-chart" class="tab-content active-grid flex-grow grid grid-cols-4 grid-rows-4 gap-1 md:gap-2 h-full">
                <div id="pos-5" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-6" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-7" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-8" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-4" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div class="col-span-2 row-span-2 bg-white bg-opacity-80 chinese-border p-1 md:p-2 center-info flex flex-col items-center justify-center text-center relative z-50">
                    <div id="basicInfo" class="space-y-0.5 w-full"></div>
                    <div id="baziDisplay" class="mt-1 flex space-x-0.5 md:space-x-2 border-t border-yellow-100 pt-1 w-full justify-around min-h-[45px] md:min-h-[60px]"></div>
                </div>
                <div id="pos-9" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-3" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-10" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-2" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-1" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-0" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-11" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
            </div>

            <div id="tab-report" class="tab-content md:flex w-full md:w-80 flex-col shrink-0 border-l-0 md:border-l border-yellow-200 md:pl-4 h-full overflow-hidden">
                <div class="flex justify-between items-center mb-1 shrink-0">
                    <label class="text-[10px] font-bold text-yellow-900">Markdown æŠ¥å‘Š</label>
                    <button onclick="copyMd()" id="copyBtn" class="bg-yellow-100 text-yellow-900 px-2 py-0.5 rounded text-[10px]">å¤åˆ¶</button>
                </div>
                <textarea id="mdOutput" readonly class="flex-grow bg-white bg-opacity-50 border border-yellow-200 rounded p-2 text-[10px] font-mono focus:outline-none resize-none leading-relaxed overflow-y-auto w-full mb-1"></textarea>
            </div>
        </div>
    </div>

    <script>
        const WUXING = { 'ç”²': 'wood', 'ä¹™': 'wood', 'å¯…': 'wood', 'å¯': 'wood', 'ä¸™': 'fire', 'ä¸': 'fire', 'å·³': 'fire', 'åˆ': 'fire', 'æˆŠ': 'earth', 'å·±': 'earth', 'è¾°': 'earth', 'æˆŒ': 'earth', 'ä¸‘': 'earth', 'æœª': 'earth', 'åºš': 'metal', 'è¾›': 'metal', 'ç”³': 'metal', 'é…‰': 'metal', 'å£¬': 'water', 'ç™¸': 'water', 'äº¥': 'water', 'å­': 'water' };
        const BRANCHES = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"];
        const ZODIAC_SIGNS = ["ç™½ç¾Š", "é‡‘ç‰›", "åŒå­", "å·¨èŸ¹", "ç‹®å­", "å¤„å¥³", "å¤©ç§¤", "å¤©è", "å°„æ‰‹", "æ‘©ç¾¯", "æ°´ç“¶", "åŒé±¼"];
        const LUNAR_MONTHS = ["æ­£æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "å†¬æœˆ", "è…Šæœˆ"];
        const LUNAR_DAYS = ["åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå", "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå", "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"];
        const PALACES = ["å‘½å®«", "å…„å¼Ÿ", "å¤«å¦»", "å­å¥³", "è´¢å¸›", "ç–¾å„", "è¿ç§»", "äº¤å‹", "å®˜ç¦„", "ç”°å®…", "ç¦å¾·", "çˆ¶æ¯"];
        const TERM_DICT = { 'æ¯”è‚©': 'åŒæˆ‘è€…ä¸ºæ¯”è‚©ã€‚\n\nä»£è¡¨ç«äº‰ã€æœ‹å‹ã€ç‹¬ç«‹æ€§ã€‚', 'åŠ«è´¢': 'åŒæˆ‘è€Œå¼‚æ€§è€…ä¸ºåŠ«è´¢ã€‚\n\nä»£è¡¨ç ´è´¢ã€ç«äº‰ã€æ„Ÿæƒ…ç”¨äº‹ã€‚', 'é£Ÿç¥': 'æˆ‘ç”Ÿè€…ä¸ºé£Ÿç¥ã€‚\n\nä»£è¡¨ç¦æ°”ã€å£æ‰ã€æ‰åã€æ¸©å’Œã€‚', 'ä¼¤å®˜': 'æˆ‘ç”Ÿè€Œå¼‚æ€§è€…ä¸ºä¼¤å®˜ã€‚\n\nä»£è¡¨æ‰åã€å›é€†ã€å˜åŠ¨ã€å‚²æ°”ã€‚', 'æ­£è´¢': 'æˆ‘å…‹è€…ä¸ºæ­£è´¢ã€‚\n\nä»£è¡¨è–ªèµ„ã€ç°å®ã€ç¨³é‡ã€å æœ‰æ¬²ã€‚', 'åè´¢': 'æˆ‘å…‹è€Œå¼‚æ€§è€…ä¸ºåè´¢ã€‚\n\nä»£è¡¨æ¨ªè´¢ã€æ…·æ…¨ã€æŠ•æœºã€å¤šæƒ…ã€‚', 'æ­£å®˜': 'å…‹æˆ‘è€…ä¸ºæ­£å®˜ã€‚\n\nä»£è¡¨åœ°ä½ã€åèª‰ã€çºªå¾‹ã€è‡ªæˆ‘çº¦æŸã€‚', 'ä¸ƒæ€': 'å…‹æˆ‘è€Œå¼‚æ€§è€…ä¸ºä¸ƒæ€ã€‚\n\nä»£è¡¨æƒåŠ›ã€å‹åŠ›ã€å‹‡æ°”ã€ç«äº‰ã€‚', 'åå°': 'ç”Ÿæˆ‘è€…ä¸ºåå°ã€‚\n\nä»£è¡¨ç›´è§‰ã€è‰ºæœ¯ã€å­¤åƒ»ã€é¢†æ‚ŸåŠ›ã€‚', 'æ­£å°': 'ç”Ÿæˆ‘è€Œå¼‚æ€§è€…ä¸ºæ­£å°ã€‚\n\nä»£è¡¨å­¦è¯†ã€æ…ˆæ‚²ã€ä¿æŠ¤ã€åèª‰ã€‚', 'æ—¥ä¸»': 'å‡ºç”Ÿæ—¥çš„å¤©å¹²ï¼Œä»£è¡¨å‘½ä¸»æœ¬äººã€‚', 'æµ·ä¸­é‡‘': 'æ·±è—ä¸éœ²ã€‚\n\nä»£è¡¨å«è“„æ·±æ²‰ã€‚', 'ç‚‰ä¸­ç«': 'çƒ­çƒˆæ—ºç››ã€‚\n\nä»£è¡¨çƒ­æƒ…æœæ–­ã€‚', 'å¤§æ—æœ¨': 'æç¹å¶èŒ‚ã€‚\n\nä»£è¡¨ä»æ…ˆæ­£ç›´ã€‚', 'è·¯æ—åœŸ': 'è¸å®å¹³ç¨³ã€‚\n\nä»£è¡¨ç¨³é‡åšé“ã€‚', 'å‰‘é”‹é‡‘': 'é”åˆ©å†³æ–­ã€‚\n\nä»£è¡¨åˆšå¼ºé”æ°”ã€‚', 'å±±å¤´ç«': 'ç«åŠ¿æé«˜ã€‚\n\nä»£è¡¨å¨ä¸¥æ€¥èºã€‚', 'æ¶§ä¸‹æ°´': 'æ¸…æ¾ˆç»†æµã€‚\n\nä»£è¡¨æŸ”å’Œè€å¿ƒã€‚', 'åŸå¤´åœŸ': 'å®ˆå«ä¹‹åœŸã€‚\n\nä»£è¡¨å¿ è¯šä¿å®ˆã€‚', 'ç™½èœ¡é‡‘': 'çº¯æ´æ˜“å¡‘ã€‚\n\nä»£è¡¨æŸ”å¼±çµæ€§ã€‚', 'æ¨æŸ³æœ¨': 'éšé£æ‘‡æ›³ã€‚\n\nä»£è¡¨çµæ´»é€‚åº”ã€‚', 'æ³‰ä¸­æ°´': 'æºå¤´æ´»æ°´ã€‚\n\nä»£è¡¨ç¿æ™ºæ¸©å’Œã€‚', 'å±‹ä¸ŠåœŸ': 'é®é£æŒ¡é›¨ã€‚\n\nä»£è¡¨è´£ä»»å­¤ç‹¬ã€‚', 'éœ¹é›³ç«': 'çˆ†å‘å¨çŒ›ã€‚\n\nä»£è¡¨æ­£ç›´çˆ†å‘ã€‚', 'æ¾æŸæœ¨': 'åšéŸ§ä¸æ‹”ã€‚\n\nä»£è¡¨é•¿å¯¿å­¤é«˜ã€‚', 'é•¿æµæ°´': 'æ»”æ»”ä¸ç»ã€‚\n\nä»£è¡¨è¿œè§å¥”æ³¢ã€‚', 'æ²™ä¸­é‡‘': 'å»ä¼ªå­˜çœŸã€‚\n\nä»£è¡¨åšéŸ§ç»†è‡´ã€‚', 'å±±ä¸‹ç«': 'æ¸è¶‹å¹³ç¼“ã€‚\n\nä»£è¡¨è°¦è™šå†…æ•›ã€‚', 'å¹³åœ°æœ¨': 'å¹³åŸä¹‹æœ¨ã€‚\n\nä»£è¡¨æœ´å®æ‹…å½“ã€‚', 'å£ä¸ŠåœŸ': 'ä¾é™„ä¾é ã€‚\n\nä»£è¡¨å¿ åšè§„çŸ©ã€‚', 'é‡‘ç®”é‡‘': 'åè€Œä¸å®ã€‚\n\nä»£è¡¨ç»†è…»è‰ºæœ¯ã€‚', 'ä½›ç¯ç«': 'ç…§äº®é»‘æš—ã€‚\n\nä»£è¡¨ä»æ…ˆå­¤ç‹¬ã€‚', 'å¤©æ²³æ°´': 'æ»‹æ¶¦ä¸‡ç‰©ã€‚\n\nä»£è¡¨åšå¤§æ©æ³½ã€‚', 'å¤§é©¿åœŸ': 'å¦è¡å®½é˜”ã€‚\n\nä»£è¡¨èƒ¸æ€€è¯šä¿¡ã€‚', 'é’—é’é‡‘': 'ç²¾å·§åä¸½ã€‚\n\nä»£è¡¨é«˜è´µç»†è…»ã€‚', 'æ¡‘æŸ˜æœ¨': 'å¥‰çŒ®å‹¤åŠ³ã€‚\n\nä»£è¡¨æŸ”é¡ºå¥‰çŒ®ã€‚', 'å¤§æºªæ°´': 'å¥”è…¾ä¸æ¯ã€‚\n\nä»£è¡¨æ´»åŠ›é›„å¿ƒã€‚', 'æ²™ä¸­åœŸ': 'æ¾æ•£å¤šå˜ã€‚\n\nä»£è¡¨éšå’Œå®½å®¹ã€‚', 'å¤©ä¸Šç«': 'å…‰æ˜ç£Šè½ã€‚\n\nä»£è¡¨åšå¤§å…¬æ­£ã€‚', 'çŸ³æ¦´æœ¨': 'å¤šæ‰å¤šè‰ºã€‚\n\nä»£è¡¨å¤šæ‰æ€§æ ¼ã€‚', 'å¤§æµ·æ°´': 'æµ©ç€šæ— å ã€‚\n\nä»£è¡¨å®½å¹¿åŒ…å®¹ã€‚' };

        function getWuXingStats(baZi) {
            const counts = { 'wood': 0, 'fire': 0, 'earth': 0, 'metal': 0, 'water': 0 };
            const chars = [baZi.getYearGan(), baZi.getYearZhi(), baZi.getMonthGan(), baZi.getMonthZhi(), baZi.getDayGan(), baZi.getDayZhi(), baZi.getTimeGan(), baZi.getTimeZhi()];
            chars.forEach(c => { if(WUXING[c]) counts[WUXING[c]]++; });
            let result = `${counts.wood}æœ¨ ${counts.fire}ç« ${counts.earth}åœŸ ${counts.metal}é‡‘ ${counts.water}æ°´`;
            const missing = [];
            if(counts.wood === 0) missing.push('æœ¨'); if(counts.fire === 0) missing.push('ç«'); if(counts.earth === 0) missing.push('åœŸ'); if(counts.metal === 0) missing.push('é‡‘'); if(counts.water === 0) missing.push('æ°´');
            if(missing.length > 0) result += ` â” [äº”è¡Œç¼º${missing.join('')}]`;
            return result;
        }

        function getShens(gan, zhi, dGan, yZhi, dZhi) {
            const shens = [];
            const ganBase = {
                'ç”²': { 'å¤©ä¹™': ['ä¸‘', 'æœª'], 'ç¾Šåˆƒ': 'å¯', 'æ–‡æ˜Œ': 'å·³' }, 'ä¹™': { 'å¤©ä¹™': ['å­', 'ç”³'], 'ç¾Šåˆƒ': 'è¾°', 'æ–‡æ˜Œ': 'åˆ' },
                'ä¸™': { 'å¤©ä¹™': ['äº¥', 'é…‰'], 'ç¾Šåˆƒ': 'åˆ', 'æ–‡æ˜Œ': 'ç”³' }, 'ä¸': { 'å¤©ä¹™': ['äº¥', 'é…‰'], 'ç¾Šåˆƒ': 'æœª', 'æ–‡æ˜Œ': 'é…‰' },
                'æˆŠ': { 'å¤©ä¹™': ['ä¸‘', 'æœª'], 'ç¾Šåˆƒ': 'åˆ', 'æ–‡æ˜Œ': 'ç”³' }, 'å·±': { 'å¤©ä¹™': ['å­', 'ç”³'], 'ç¾Šåˆƒ': 'æœª', 'æ–‡æ˜Œ': 'é…‰' },
                'åºš': { 'å¤©ä¹™': ['ä¸‘', 'æœª'], 'ç¾Šåˆƒ': 'é…‰', 'æ–‡æ˜Œ': 'äº¥' }, 'è¾›': { 'å¤©ä¹™': ['å¯…', 'åˆ'], 'ç¾Šåˆƒ': 'æˆŒ', 'æ–‡æ˜Œ': 'å­' },
                'å£¬': { 'å¤©ä¹™': ['å¯', 'å·³'], 'ç¾Šåˆƒ': 'å­', 'æ–‡æ˜Œ': 'å¯…' }, 'ç™¸': { 'å¤©ä¹™': ['å¯', 'å·³'], 'ç¾Šåˆƒ': 'ä¸‘', 'æ–‡æ˜Œ': 'å¯' }
            };
            const zhiBase = {
                'æ¡ƒèŠ±': { 'å¯…': 'å¯', 'åˆ': 'å¯', 'æˆŒ': 'å¯', 'ç”³': 'é…‰', 'å­': 'é…‰', 'è¾°': 'é…‰', 'å·³': 'åˆ', 'é…‰': 'åˆ', 'ä¸‘': 'åˆ', 'äº¥': 'å­', 'å¯': 'å­', 'æœª': 'å­' },
                'é©¿é©¬': { 'å¯…': 'ç”³', 'åˆ': 'ç”³', 'æˆŒ': 'ç”³', 'ç”³': 'å¯…', 'å­': 'å¯…', 'è¾°': 'å¯…', 'å·³': 'äº¥', 'é…‰': 'äº¥', 'ä¸‘': 'äº¥', 'äº¥': 'å·³', 'å¯': 'å·³', 'æœª': 'å·³' },
                'åç›–': { 'å¯…': 'æˆŒ', 'åˆ': 'æˆŒ', 'æˆŒ': 'æˆŒ', 'ç”³': 'è¾°', 'å­': 'è¾°', 'è¾°': 'è¾°', 'å·³': 'ä¸‘', 'é…‰': 'ä¸‘', 'ä¸‘': 'ä¸‘', 'äº¥': 'æœª', 'å¯': 'æœª', 'æœª': 'æœª' }
            };
            if (ganBase[dGan].å¤©ä¹™.includes(zhi)) shens.push('å¤©ä¹™è´µäºº');
            if (ganBase[dGan].ç¾Šåˆƒ === zhi) shens.push('ç¾Šåˆƒ');
            if (ganBase[dGan].æ–‡æ˜Œ === zhi) shens.push('æ–‡æ˜Œ');
            if (zhiBase.æ¡ƒèŠ±[yZhi] === zhi || zhiBase.æ¡ƒèŠ±[dZhi] === zhi) shens.push('æ¡ƒèŠ±');
            if (zhiBase.é©¿é©¬[yZhi] === zhi || zhiBase.é©¿é©¬[dZhi] === zhi) shens.push('é©¿é©¬');
            if (zhiBase.åç›–[yZhi] === zhi || zhiBase.åç›–[dZhi] === zhi) shens.push('åç›–');
            return shens;
        }

        const CITY_DATA = { "åŒ—äº¬å¸‚": {"åŒ—äº¬å¸‚": [116.40, 39.90]}, "ä¸Šæµ·å¸‚": {"ä¸Šæµ·å¸‚": [121.47, 31.23]}, "å¤©æ´¥å¸‚": {"å¤©æ´¥å¸‚": [117.20, 39.12]}, "é‡åº†å¸‚": {"é‡åº†å¸‚": [106.50, 29.53]}, "å¹¿ä¸œçœ": {"å¹¿å·å¸‚": [113.23, 23.16], "æ·±åœ³å¸‚": [114.07, 22.62], "ç æµ·å¸‚": [113.52, 22.30], "ä¸œèå¸‚": [113.75, 23.04], "ä¸­å±±å¸‚": [113.38, 22.52]}, "æµ™æ±Ÿçœ": {"æ­å·å¸‚": [120.19, 30.26], "å®æ³¢å¸‚": [121.56, 29.86], "æ¸©å·å¸‚": [120.67, 28.00]}, "æ±Ÿè‹çœ": {"å—äº¬å¸‚": [118.78, 32.04], "è‹å·å¸‚": [120.62, 31.32], "æ— é”¡å¸‚": [120.29, 31.59]}, "å››å·çœ": {"æˆéƒ½å¸‚": [104.06, 30.67]}, "å‰æ—çœ": {"é€šåŒ–å¸‚": [125.93, 41.73]} };

        function getEOT(doy) { const b = (2 * Math.PI * (doy - 81)) / 365; return 9.87 * Math.sin(2 * b) - 7.53 * Math.cos(b) - 1.5 * Math.sin(b); }
        function getSolarTimeOffset(lng, y, m, d) {
            const longOff = (lng - 120.0) * 4;
            const date = new Date(y, m - 1, d);
            const start = new Date(y, 0, 0);
            const doy = Math.floor((date - start) / 86400000);
            const eotOff = getEOT(doy);
            return { total: longOff + eotOff, longOff, eotOff };
        }

        function getAscendant(year, month, day, hh, mm, lng, lat) {
            const date = new Date(Date.UTC(year, month - 1, day, hh, mm));
            const jd = (date.getTime() / 86400000) + 2440587.5;
            const t = (jd - 2451545.0) / 36525.0;
            let gmst = 6.697374558 + 0.06570982441908 * (jd - 2451545.0) + 1.00273790935 * (hh + mm / 60);
            gmst = gmst % 24; if (gmst < 0) gmst += 24;
            let lst = gmst + lng / 15;
            lst = lst % 24; if (lst < 0) lst += 24;
            const ram = lst * 15 * Math.PI / 180;
            const eps = (23.4393 - 0.013 * t) * Math.PI / 180;
            const phi = lat * Math.PI / 180;
            let asc = Math.atan2(-Math.cos(ram), Math.sin(ram) * Math.cos(eps) + Math.tan(phi) * Math.sin(eps));
            asc = asc * 180 / Math.PI; if (asc < 0) asc += 360;
            return ZODIAC_SIGNS[Math.floor(asc / 30)];
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active-grid', 'active-flex');
            });
            const target = document.getElementById('tab-' + tabId);
            if (tabId === 'chart') target.classList.add('active-grid');
            else target.classList.add('active-flex');
            
            document.querySelectorAll('[id^="tabBtn-"]').forEach(b => b.classList.remove('border-yellow-900', 'text-yellow-900'));
            document.querySelectorAll('[id^="tabBtn-"]').forEach(b => b.classList.add('border-transparent', 'text-gray-400'));
            document.getElementById('tabBtn-' + tabId).classList.add('border-yellow-900', 'text-yellow-900');
            document.getElementById('tabBtn-' + tabId).classList.remove('border-transparent', 'text-gray-400');
        }

        window.onload = function() {
            const lastData = JSON.parse(localStorage.getItem('bazi_last_input')) || {};
            const now = new Date();
            const defY = lastData.y || now.getFullYear(), defM = lastData.m || (now.getMonth() + 1), defD = lastData.d || now.getDate();
            const defH = lastData.hh !== undefined ? lastData.hh : now.getHours(), defMin = lastData.mm !== undefined ? lastData.mm : now.getMinutes();
            const defGen = lastData.gender || "1", defUnk = lastData.unknown || false, defCal = lastData.cal || "solar";
            const defProv = lastData.province || "åŒ—äº¬å¸‚", defCity = lastData.city || "åŒ—äº¬å¸‚", defUseSolar = lastData.useSolar || false;

            const yearSel = document.getElementById('inputYear'), monthSel = document.getElementById('inputMonth'), daySel = document.getElementById('inputDay');
            const hourSel = document.getElementById('inputHour'), minSel = document.getElementById('inputMin');
            const unkCheck = document.getElementById('timeUnknown'), provSel = document.getElementById('provinceSel'), citySel = document.getElementById('citySel'), solarCheck = document.getElementById('useSolarTime');

            for(let i=1900; i<=2100; i++) yearSel.add(new Option(i + 'å¹´', i, i===defY, i===defY));
            for(let i=0; i<24; i++) hourSel.add(new Option(String(i).padStart(2, '0') + 'æ—¶', i, i===defH, i===defH));
            for(let i=0; i<60; i++) minSel.add(new Option(String(i).padStart(2, '0') + 'åˆ†', i, i===defMin, i===defMin));
            Object.keys(CITY_DATA).forEach(p => provSel.add(new Option(p, p, p===defProv, p===defProv)));

            function getCalType() { return document.querySelector('input[name="calType"]:checked').value; }
            function updateCityOptions() { citySel.innerHTML = ''; const p = provSel.value; Object.keys(CITY_DATA[p]).forEach(c => citySel.add(new Option(c, c, c===defCity, c===defCity))); }
            function updateDayOptions() {
                const y = parseInt(yearSel.value), type = getCalType(); monthSel.innerHTML = ''; daySel.innerHTML = '';
                if (type === 'solar') {
                    for(let i=1; i<=12; i++) monthSel.add(new Option(String(i).padStart(2, '0') + 'æœˆ', i, i===defM, i===defM));
                    const last = new Date(y, parseInt(monthSel.value), 0).getDate();
                    for(let i=1; i<=last; i++) daySel.add(new Option(String(i).padStart(2, '0') + 'æ—¥', i, i===Math.min(defD, last), i===Math.min(defD, last)));
                } else {
                    const months = LunarYear.fromYear(y).getMonths();
                    months.forEach(m => monthSel.add(new Option(m.isLeap() ? "é—°" + LUNAR_MONTHS[m.getMonth()-1] : LUNAR_MONTHS[m.getMonth()-1], m.getMonth() * (m.isLeap() ? -1 : 1))));
                    const mVal = parseInt(monthSel.value); const m = months.find(mm => mm.getMonth() === Math.abs(mVal) && mm.isLeap() === (mVal < 0)) || months[0];
                    for(let i=1; i<=m.getDayCount(); i++) daySel.add(new Option(LUNAR_DAYS[i-1], i));
                }
            }

            document.querySelectorAll('input[name="calType"]').forEach(r => r.onchange = () => { updateDayOptions(); updateDisplay(); });
            yearSel.onchange = () => { updateDayOptions(); updateDisplay(); };
            monthSel.onchange = () => { updateDisplay(); };
            daySel.onchange = updateDisplay; hourSel.onchange = updateDisplay; minSel.onchange = updateDisplay;
            provSel.onchange = () => { updateCityOptions(); updateDisplay(); };
            citySel.onchange = updateDisplay; solarCheck.onchange = updateDisplay;
            unkCheck.onchange = () => { document.getElementById('timeInputGroup').style.opacity = unkCheck.checked ? "0.3" : "1"; updateDisplay(); };

            const shichenGrid = document.getElementById('shichenGrid');
            BRANCHES.forEach((b, i) => {
                const btn = document.createElement('button'); btn.innerText = b + 'æ—¶';
                btn.className = "px-2 py-0.5 text-[9px] border border-yellow-300 rounded hover:bg-yellow-100 transition sc-btn";
                btn.onclick = () => { unkCheck.checked = false; hourSel.value = (i * 2 + 23) % 24; minSel.value = 0; updateDisplay(); };
                shichenGrid.appendChild(btn);
            });

            updateCityOptions(); updateDayOptions(); 
            document.querySelector(`input[name="calType"][value="${defCal}"]`).checked = true;
            unkCheck.checked = defUnk; solarCheck.checked = defUseSolar;
            document.getElementById('timeInputGroup').style.opacity = defUnk ? "0.3" : "1";
            document.querySelector(`input[name="gender"][value="${defGen}"]`).checked = true;
            document.getElementById('btnCalculate').onclick = updateDisplay;
            updateDisplay();
        };

        function getWuXingClass(char) { return `color-${WUXING[char] || 'metal'}`; }
        function renderPillar(title, gan, zhi, hide, ssGan, ssZhi, nayin, isDM = false) {
            const tipGan = TERM_DICT[ssGan] || ''; const tipZhi = TERM_DICT[ssZhi] || ''; const tipNaYin = TERM_DICT[nayin] || '';
            return `<div class="flex flex-col items-center ${isDM ? 'pillar-highlight' : ''}">
                    <span class="text-[8px] md:text-[10px] text-red-700 font-bold mb-0.5" ${tipGan ? `data-tip="${ssGan}: ${tipGan}"` : ''}>${ssGan||''}</span>
                    <span class="text-[8px] md:text-[10px] text-yellow-800">${title}</span>
                    <span class="text-base md:text-xl font-bold ${getWuXingClass(gan)}">${gan}</span>
                    <span class="text-base md:text-xl font-bold ${getWuXingClass(zhi)}">${zhi}</span>
                    <div class="flex flex-col items-center leading-none mt-0.5">
                        <span style="color: rgba(44,62,80,0.4)" class="text-[7px] md:text-[9px]">${hide||''}</span>
                        <span style="color: rgba(192,72,81,0.6)" class="text-[7px] md:text-[8px] scale-90" ${tipZhi ? `data-tip="${ssZhi}: ${tipZhi}"` : ''}>${ssZhi||''}</span>
                        <span style="color: rgba(139,69,19,0.5)" class="text-[7px] md:text-[8px] mt-0.5 scale-90 whitespace-nowrap" ${tipNaYin ? `data-tip="${nayin}: ${tipNaYin}"` : ''}>${nayin||''}</span>
                    </div>
                </div>`;
        }

        function updateDisplay() {
            try {
                const y = parseInt(document.getElementById('inputYear').value), m = parseInt(document.getElementById('inputMonth').value), d = parseInt(document.getElementById('inputDay').value);
                const hh = parseInt(document.getElementById('inputHour').value), mm = parseInt(document.getElementById('inputMin').value);
                const type = document.querySelector('input[name="calType"]:checked').value;
                const gen = document.querySelector('input[name="gender"]:checked').value, unk = document.getElementById('timeUnknown').checked;
                const prov = document.getElementById('provinceSel').value, city = document.getElementById('citySel').value, useSolar = document.getElementById('useSolarTime').checked;
                localStorage.setItem('bazi_last_input', JSON.stringify({ y, m, d, hh, mm, gender: gen, unknown: unk, province: prov, city, useSolar, cal: type }));

                let solar;
                if (type === 'solar') solar = Solar.fromYmdHms(y, m, d, hh, mm, 0);
                else { const lunar = Lunar.fromYmd(y, Math.abs(m), d); if (m < 0) lunar.setLeap(true); solar = lunar.getSolar(); solar = Solar.fromYmdHms(solar.getYear(), solar.getMonth(), solar.getDay(), hh, mm, 0); }

                const [lng, lat] = CITY_DATA[prov][city];
                document.getElementById('lngDisplay').innerText = `(${lng},${lat})`;
                const off = getSolarTimeOffset(lng, solar.getYear(), solar.getMonth(), solar.getDay());
                let cSol = solar;
                if (useSolar && !unk) {
                    const cD = new Date(new Date(solar.getYear(), solar.getMonth()-1, solar.getDay(), hh, mm).getTime() + off.total * 60000);
                    cSol = Solar.fromYmdHms(cD.getFullYear(), cD.getMonth()+1, cD.getDate(), cD.getHours(), cD.getMinutes(), 0);
                }
                const lunar = Lunar.fromSolar(cSol), baZi = lunar.getEightChar();
                const yun = baZi.getYun(gen === '1' ? 1 : 0);
                const startSolar = yun.getStartSolar();
                const dayuns = yun.getDaYun();
                const wxStats = getWuXingStats(baZi);
                const taiYuan = baZi.getTaiYuan();
                const mingGong = baZi.getMingGong();
                const shenGong = baZi.getShenGong();
                const dayKong = baZi.getDayXunKong();
                const yearKong = baZi.getYearXunKong();

                const shensN = getShens(baZi.getYearGan(), baZi.getYearZhi(), baZi.getDayGan(), baZi.getYearZhi(), baZi.getDayZhi());
                const shensY = getShens(baZi.getMonthGan(), baZi.getMonthZhi(), baZi.getDayGan(), baZi.getYearZhi(), baZi.getDayZhi());
                const shensR = getShens(baZi.getDayGan(), baZi.getDayZhi(), baZi.getDayGan(), baZi.getYearZhi(), baZi.getDayZhi());
                const shensS = unk ? [] : getShens(baZi.getTimeGan(), baZi.getTimeZhi(), baZi.getDayGan(), baZi.getYearZhi(), baZi.getDayZhi());

                const mgBranch = mingGong[1];
                const mgIdx = BRANCHES.indexOf(mgBranch);
                const palaceMap = {};
                for (let i = 0; i < 12; i++) {
                    const branchIdx = (mgIdx - i + 12) % 12;
                    palaceMap[BRANCHES[branchIdx]] = PALACES[i];
                }

                const asc = unk ? "?" : getAscendant(cSol.getYear(), cSol.getMonth(), cSol.getDay(), cSol.getHour(), cSol.getMinute(), lng, lat);

                if (!unk) {
                    let st = cSol.getHour() % 2 === 0 ? cSol.getHour() - 1 : cSol.getHour(); if (st === -1) st = 23;
                    document.getElementById('shichenInfo').innerHTML = `æ—¶è¾°:${String(st).padStart(2, '0')}:00~${String((st+2)%24).padStart(2, '0')}:00 | ä¿®æ­£:${off.total.toFixed(1)}åˆ†`;
                    document.querySelectorAll('.sc-btn').forEach(btn => btn.innerText.startsWith(baZi.getTimeZhi()) ? btn.classList.add('bg-yellow-700', 'text-white') : btn.classList.remove('bg-yellow-700', 'text-white'));
                } else { document.getElementById('shichenInfo').innerText = "å‡ºç”Ÿæ—¶è¾°ä¸è¯¦"; }

                document.getElementById('basicInfo').innerHTML = `<div class="text-[12px] md:text-[13px] font-bold">${cSol.toYmd()} ${unk ? '' : String(cSol.getHour()).padStart(2, '0')+':'+String(cSol.getMinute()).padStart(2, '0')}</div><div class="text-[10px] md:text-[11px] text-yellow-900">${lunar.getMonthInChinese()}æœˆ ${lunar.getDayInChinese()} ${unk ? '' : '('+baZi.getTimeZhi()+'æ—¶)'}</div><div class="flex flex-wrap justify-center gap-x-1 text-[8px] md:text-[9px] mt-0.5 opacity-80"><span>${lunar.getYearShengXiao()}</span><span class="cursor-help" data-tip="å¤ªé˜³æ˜Ÿåº§ï¼šä»£è¡¨ä¸€ä¸ªäººçš„åŸºæœ¬æ€§æ ¼ã€‚">${cSol.getXingZuo()}åº§</span><span class="text-red-800 font-bold cursor-help" data-tip="ä¸Šå‡æ˜Ÿåº§ï¼šä»£è¡¨ç»™äººçš„ç¬¬ä¸€å°è±¡ã€‚">(${asc})</span></div>`;
                document.getElementById('baziDisplay').innerHTML = `${renderPillar('å¹´', baZi.getYearGan(), baZi.getYearZhi(), baZi.getYearHideGan().join(''), baZi.getYearShiShenGan(), baZi.getYearShiShenZhi()[0], lunar.getYearNaYin())}${renderPillar('æœˆ', baZi.getMonthGan(), baZi.getMonthZhi(), baZi.getMonthHideGan().join(''), baZi.getMonthShiShenGan(), baZi.getMonthShiShenZhi()[0], lunar.getMonthNaYin())}${renderPillar('æ—¥', baZi.getDayGan(), baZi.getDayZhi(), baZi.getDayHideGan().join(''), 'æ—¥ä¸»', baZi.getDayShiShenZhi()[0], lunar.getDayNaYin(), true)}${unk ? '<div class="flex flex-col items-center opacity-20"><span class="text-[9px] text-yellow-800">æ—¶</span><span class="text-xl font-bold text-gray-300">?</span></div>' : renderPillar('æ—¶', baZi.getTimeGan(), baZi.getTimeZhi(), baZi.getTimeHideGan().join(''), baZi.getTimeShiShenGan(), baZi.getTimeShiShenZhi()[0], lunar.getTimeNaYin())}`;

                BRANCHES.forEach((branch, index) => {
                    const cell = document.getElementById(`pos-${index}`);
                    const isT = !unk && baZi.getTimeZhi() === branch, isY = baZi.getYearZhi() === branch;
                    const pName = palaceMap[branch];
                    cell.innerHTML = `<div class="flex justify-between items-start"><span class="text-base font-bold ${getWuXingClass(branch)}">${branch}</span><div class="flex flex-col items-end">${isT?'<span class="bg-red-700 text-white text-[7px] px-0.5 rounded">æ—¶</span>':''}${isY?'<span class="bg-yellow-700 text-white text-[7px] px-0.5 rounded">å¹´</span>':''}</div></div><div class="text-[9px] md:text-[10px] text-yellow-900 text-right mt-auto">${pName}</div>`;
                    cell.style.backgroundColor = isT ? "rgba(254, 243, 199, 0.8)" : "";
                    if (pName === 'å‘½å®«') cell.classList.add('ring-1', 'ring-red-300');
                    else cell.classList.remove('ring-1', 'ring-red-300');
                });

                let mdText = `### é—®å¤©æ˜Ÿç®—æ’ç›˜æŠ¥å‘Š\n\n- **å…¬å†**: ${cSol.toYmd()} ${unk ? 'ä¸è¯¦' : String(cSol.getHour()).padStart(2, '0')+':'+String(cSol.getMinute()).padStart(2, '0')}\n- **åœ°ç‚¹**: ${prov}-${city} (${lng}, ${lat})\n- **å†œå†**: ${lunar.getYearInChinese()}å¹´ ${lunar.getMonthInChinese()}æœˆ ${lunar.getDayInChinese()}\n- **${unk?'å…­å­—':'å…«å­—'}**: ${baZi.getYearGan()}${baZi.getYearZhi()}å¹´ ${baZi.getMonthGan()}${baZi.getMonthZhi()}æœˆ ${baZi.getDayGan()}${baZi.getDayZhi()}æ—¥${unk?'':' '+baZi.getTimeGan()+baZi.getTimeZhi()+'æ—¶'}\n- **å¤ªé˜³æ˜Ÿåº§**: ${cSol.getXingZuo()}åº§ / **ä¸Šå‡æ˜Ÿåº§**: ${asc}åº§\n- **çœŸå¤ªé˜³æ—¶ä¿®æ­£**: ${off.total.toFixed(2)} åˆ†é’Ÿ\n- **æ€§åˆ«**: ${gen==='1'?'ç”·':'å¥³'} / **ç”Ÿè‚–**: ${lunar.getYearShengXiao()} (${lunar.getYearNaYin()})\n\n#### ç”Ÿè¾°å…«å­— (${unk?'å…­å­—' : 'å…«å­—'})\n| å››æŸ± | å¹´æŸ± | æœˆæŸ± | æ—¥æŸ± | æ—¶æŸ± |\n| :--- | :--- | :--- | :--- | :--- |\n| **åç¥** | ${baZi.getYearShiShenGan()} | ${baZi.getMonthShiShenGan()} | æ—¥ä¸» | ${unk?'?':baZi.getTimeShiShenGan()} |\n| **å¹²æ”¯** | ${baZi.getYearGan()}${baZi.getYearZhi()} | ${baZi.getMonthGan()}${baZi.getMonthZhi()} | ${baZi.getDayGan()}${baZi.getDayZhi()} | ${unk?'??':baZi.getTimeGan()+baZi.getTimeZhi()} |\n| **åœ°åŠ¿** | ${baZi.getYearShiShenZhi()[0]} | ${baZi.getMonthShiShenZhi()[0]} | ${baZi.getDayShiShenZhi()[0]} | ${unk?'?':baZi.getTimeShiShenZhi()[0]} |\n| **çº³éŸ³** | ${lunar.getYearNaYin()} | ${lunar.getMonthNaYin()} | ${lunar.getDayNaYin()} | ${unk?'?':lunar.getTimeNaYin()} |\n| **è—å¹²** | ${baZi.getYearHideGan().join('')} | ${baZi.getMonthHideGan().join('')} | ${baZi.getDayHideGan().join('')} | ${unk?'?':baZi.getTimeHideGan().join('')} |\n\n### ğŸ“Š å‘½å±€äº”è¡Œä¸åŸºç¡€å‚æ•°\n- **äº”è¡Œç»Ÿè®¡**ï¼š${wxStats}\n- **ç©ºäº¡**ï¼šæ—¥ç©º[${dayKong}] | å¹´ç©º[${yearKong}]\n- **ä¸‰å£**ï¼šèƒå…ƒ[${taiYuan}] | å‘½å®«[${mingGong}] | èº«å®«[${shenGong}]\n\n### ğŸŒŸ å››æŸ±ç¥ç… (è§£ç›˜å…³é”®å–è±¡)\n- **å¹´æŸ±** (${baZi.getYearGan()}${baZi.getYearZhi()}): [${shensN.join(', ') || 'æ— '}]\n- **æœˆæŸ±** (${baZi.getMonthGan()}${baZi.getMonthZhi()}): [${shensY.join(', ') || 'æ— '}]\n- **æ—¥æŸ±** (${baZi.getDayGan()}${baZi.getDayZhi()}): [${shensR.join(', ') || 'æ— '}]\n- **æ—¶æŸ±** (${unk?'??' : baZi.getTimeGan()+baZi.getTimeZhi()}): [${shensS.join(', ') || 'æ— '}]\n\n### â³ å‘½è¿è½¨è¿¹ (å¤§è¿èµ°åŠ¿)\n**äº¤è¿æ—¶é—´**: å‡ºç”Ÿå ${yun.getStartYear()} å¹´ ${yun.getStartMonth()} ä¸ªæœˆ ${yun.getStartDay()} å¤©äº¤è¿ (å…¬å† ${startSolar.toYmd()} èµ·è¿)\n| æ­¥æ•° | è™šå² | èµ·è¿å¹´ä»½ | å¤§è¿å¹²æ”¯ |\n| --- | --- | --- | --- |\n`;
                
                dayuns.slice(1, 9).forEach((dy, i) => {
                    mdText += `| ${i+1} | ${dy.getStartAge()}å² | ${dy.getStartYear()} | ${dy.getGanZhi()} |\n`;
                });

                mdText += `\n### ğŸŒŒ åäºŒå®«ä½åˆ†å¸ƒ\n`;
                const pList = BRANCHES.map(b => `- **${b}å®«**: ${palaceMap[b]}å®«`).join(' | ');
                mdText += pList + `\n\n---\n*æŠ¥å‘Šç”±é—®å¤©æ˜Ÿç®—ç”Ÿæˆï¼Œ${useSolar?'å·²åº”ç”¨çœŸå¤ªé˜³æ—¶ä¿®æ­£':'æœªåº”ç”¨ä¿®æ­£'}*`;

                document.getElementById('mdOutput').value = mdText;
            } catch (e) { console.error(e); }
        }
        function copyMd() { const area = document.getElementById('mdOutput'); const btn = document.getElementById('copyBtn'); area.select(); document.execCommand('copy'); btn.innerText = 'å·²å¤åˆ¶'; setTimeout(() => { btn.innerText = 'å¤åˆ¶'; }, 1500); }
    </script>
</body>
</html>
