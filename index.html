<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈóÆÂ§©ÊòüÁÆó - ‰∏ì‰∏öÂëΩÁêÜÊéíÁõò</title>
    <link rel="stylesheet" href="tailwind.min.css">
    <script src="lunar.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Noto Serif SC", "Source Han Serif SC", "Source Han Serif CN", "Songti SC", "STSong", "SimSun", serif; background-color: #F5F5DC; color: #2C3E50; -webkit-tap-highlight-color: transparent; font-size: 13px; }
        .chinese-border { border: 1px solid #8B4513; position: relative; }
        .chinese-border::after { content: ''; position: absolute; top: 1px; left: 1px; right: 1px; bottom: 1px; border: 1px solid #8B4513; pointer-events: none; z-index: -1; }
        .palace-cell { transition: all 0.3s ease; min-width: 0; overflow: visible !important; }
        .palace-cell:hover { background-color: #E9E9D0; }
        .color-wood { color: #2D5A27; } .color-fire { color: #C04851; } .color-earth { color: #8B7042; } .color-metal { color: #9D9087; } .color-water { color: #1A1A1A; }
        .pillar-highlight { border-bottom: 2px solid #C04851; }
        
        /* Tooltip Âü∫Á°ÄÊ†∑Âºè */
        [data-tip] { position: relative; cursor: help; z-index: 10; }
        [data-tip]:hover::after {
            content: attr(data-tip); position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
            padding: 6px 10px; background-color: #FFFDE7 !important; color: #5D4037 !important; font-size: 10px; white-space: pre-wrap;
            width: 150px; border: 1px solid #8B4513; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999; line-height: 1.5; font-weight: normal; opacity: 1 !important; visibility: visible; text-align: left;
        }
        
        @media (max-width: 768px) {
            .center-info, #baziDisplay, #basicInfo { overflow: visible !important; }
            .tab-content { display: none !important; }
            .tab-content.active-grid { display: grid !important; }
            .tab-content.active-flex { display: flex !important; }
            
            .palace-cell { aspect-ratio: 1 / 1.1; padding: 2px !important; }
            .palace-cell span.text-lg { font-size: 1rem !important; }
            .center-info { padding: 4px !important; }
            #basicInfo, #baziDisplay { transform: scale(0.9); transform-origin: center top; width: 100%; }
            #baziDisplay span.text-xl { font-size: 1rem !important; }
            #baziDisplay .text-[9px], #baziDisplay .text-[8px] { font-size: 7px !important; transform: scale(0.9); }
            #shichenInfo { font-size: 8px !important; line-height: 1; }
            .sc-btn { padding: 2px 4px !important; font-size: 8px !important; }
        }
    </style>
</head>
<body class="p-1 md:p-4 h-screen overflow-hidden flex flex-col">
    <div class="max-w-6xl mx-auto flex-grow flex flex-col w-full h-full min-h-0">
        <header class="text-center mb-1 shrink-0">
            <h1 class="text-lg md:text-2xl font-bold text-yellow-900">ÈóÆÂ§©ÊòüÁÆó</h1>
        </header>

        <section class="bg-white bg-opacity-50 p-2 rounded shadow-sm border border-yellow-200 mb-1 md:mb-4 shrink-0">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 items-end">
                <div class="col-span-1">
                    <div class="flex justify-between items-center mb-0.5">
                        <label class="block text-[10px] font-bold text-yellow-900">Êó•Êúü</label>
                        <div class="flex items-center space-x-1 text-[8px] md:text-[9px] text-yellow-700">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="calType" value="solar" checked class="mr-0.5">ÂÖ¨</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="calType" value="lunar" class="mr-0.5">ÂÜú</label>
                        </div>
                    </div>
                    <div class="flex items-center space-x-0.5 border-b border-yellow-900">
                        <select id="inputYear" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">-</span>
                        <select id="inputMonth" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">-</span>
                        <select id="inputDay" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                    </div>
                </div>
                <div class="col-span-1">
                    <div class="flex justify-between items-center mb-0.5">
                        <label class="block text-[10px] font-bold text-yellow-900">Êó∂Èó¥</label>
                        <label class="flex items-center text-[10px] cursor-pointer text-yellow-700">
                            <input type="checkbox" id="timeUnknown" class="mr-1 scale-75">‰∏çËØ¶
                        </label>
                    </div>
                    <div id="timeInputGroup" class="flex items-center space-x-0.5 border-b border-yellow-900">
                        <select id="inputHour" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                        <span class="text-yellow-900">:</span>
                        <select id="inputMin" class="bg-transparent text-[11px] md:text-xs focus:outline-none appearance-none cursor-pointer flex-grow text-center"></select>
                    </div>
                </div>
                <div class="col-span-1">
                    <label class="block text-[10px] font-bold text-yellow-900 mb-0.5">ÊÄßÂà´</label>
                    <div class="flex space-x-2 text-[11px] md:text-xs py-0.5">
                        <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="1" checked class="mr-0.5">Áî∑</label>
                        <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="0" class="mr-0.5">Â•≥</label>
                    </div>
                </div>
                <div class="col-span-1">
                    <button id="btnCalculate" class="w-full bg-yellow-900 text-white py-1 rounded text-xs hover:bg-yellow-800 transition">ÈáçÁªò</button>
                </div>
            </div>
            <div id="shichenGrid" class="flex flex-wrap gap-1 mt-1.5 border-t border-yellow-100 pt-1.5"></div>
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1.5 border-t border-yellow-100 pt-1.5">
                <div class="flex items-center space-x-1">
                    <select id="provinceSel" class="bg-transparent text-[10px] border-b border-yellow-900 focus:outline-none cursor-pointer"></select>
                    <select id="citySel" class="bg-transparent text-[10px] border-b border-yellow-900 focus:outline-none cursor-pointer"></select>
                    <span id="lngDisplay" class="text-[8px] text-yellow-700 opacity-60"></span>
                </div>
                <div id="shichenInfo" class="text-[9px] text-red-800 opacity-80 font-mono"></div>
                <label class="flex items-center text-[10px] cursor-pointer text-red-900 font-bold ml-auto">
                    <input type="checkbox" id="useSolarTime" class="mr-1 scale-75">ÁúüÂ§™Èò≥Êó∂
                </label>
            </div>
        </section>

        <div class="flex md:hidden border-b border-yellow-200 mb-2 shrink-0">
            <button onclick="switchTab('chart')" id="tabBtn-chart" class="flex-1 py-2 text-xs font-bold border-b-2 border-yellow-900 text-yellow-900">ÂëΩÁõòÁΩëÊ†º</button>
            <button onclick="switchTab('report')" id="tabBtn-report" class="flex-1 py-2 text-xs font-bold border-b-2 border-transparent text-gray-400">ÊñáÂ≠óÊä•Âëä</button>
        </div>

        <div class="flex flex-col md:flex-row gap-2 md:gap-4 flex-grow overflow-hidden min-h-0">
            <div id="tab-chart" class="tab-content active-grid flex-grow grid grid-cols-4 grid-rows-4 gap-1 md:gap-2 h-full">
                <div id="pos-5" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-6" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-7" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-8" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-4" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div class="col-span-2 row-span-2 bg-white bg-opacity-80 chinese-border p-1 md:p-2 center-info flex flex-col items-center justify-center text-center relative z-50">
                    <div id="basicInfo" class="space-y-0.5 w-full"></div>
                    <div id="baziDisplay" class="mt-1 flex space-x-0.5 md:space-x-2 border-t border-yellow-100 pt-1 w-full justify-around min-h-[45px] md:min-h-[60px]"></div>
                </div>
                <div id="pos-9" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-3" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-10" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-2" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-1" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-0" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
                <div id="pos-11" class="palace-cell chinese-border p-1 flex flex-col justify-between bg-white bg-opacity-30"></div>
            </div>

            <div id="tab-report" class="tab-content md:flex w-full md:w-80 flex-col shrink-0 border-l-0 md:border-l border-yellow-200 md:pl-4 h-full overflow-hidden">
                <div class="flex justify-between items-center mb-1 shrink-0">
                    <label class="text-[10px] font-bold text-yellow-900">Markdown Êä•Âëä</label>
                    <button onclick="copyMd()" id="copyBtn" class="bg-yellow-100 text-yellow-900 px-2 py-0.5 rounded text-[10px]">Â§çÂà∂</button>
                </div>
                <textarea id="mdOutput" readonly class="flex-grow bg-white bg-opacity-50 border border-yellow-200 rounded p-2 text-[10px] font-mono focus:outline-none resize-none leading-relaxed overflow-y-auto w-full mb-1"></textarea>
            </div>
        </div>
    </div>

    <script>
        const WUXING = { 'Áî≤': 'wood', '‰πô': 'wood', 'ÂØÖ': 'wood', 'ÂçØ': 'wood', '‰∏ô': 'fire', '‰∏Å': 'fire', 'Â∑≥': 'fire', 'Âçà': 'fire', 'Êàä': 'earth', 'Â∑±': 'earth', 'Ëæ∞': 'earth', 'Êàå': 'earth', '‰∏ë': 'earth', 'Êú™': 'earth', 'Â∫ö': 'metal', 'Ëæõ': 'metal', 'Áî≥': 'metal', 'ÈÖâ': 'metal', 'Â£¨': 'water', 'Áô∏': 'water', '‰∫•': 'water', 'Â≠ê': 'water' };
        const BRANCHES = ["Â≠ê", "‰∏ë", "ÂØÖ", "ÂçØ", "Ëæ∞", "Â∑≥", "Âçà", "Êú™", "Áî≥", "ÈÖâ", "Êàå", "‰∫•"];
        const ZODIAC_SIGNS = ["ÁôΩÁæä", "ÈáëÁâõ", "ÂèåÂ≠ê", "Â∑®Ëüπ", "ÁãÆÂ≠ê", "Â§ÑÂ•≥", "Â§©Áß§", "Â§©Ëùé", "Â∞ÑÊâã", "Êë©ÁæØ", "Ê∞¥Áì∂", "ÂèåÈ±º"];
        const LUNAR_MONTHS = ["Ê≠£Êúà", "‰∫åÊúà", "‰∏âÊúà", "ÂõõÊúà", "‰∫îÊúà", "ÂÖ≠Êúà", "‰∏ÉÊúà", "ÂÖ´Êúà", "‰πùÊúà", "ÂçÅÊúà", "ÂÜ¨Êúà", "ËÖäÊúà"];
        const LUNAR_DAYS = ["Âàù‰∏Ä", "Âàù‰∫å", "Âàù‰∏â", "ÂàùÂõõ", "Âàù‰∫î", "ÂàùÂÖ≠", "Âàù‰∏É", "ÂàùÂÖ´", "Âàù‰πù", "ÂàùÂçÅ", "ÂçÅ‰∏Ä", "ÂçÅ‰∫å", "ÂçÅ‰∏â", "ÂçÅÂõõ", "ÂçÅ‰∫î", "ÂçÅÂÖ≠", "ÂçÅ‰∏É", "ÂçÅÂÖ´", "ÂçÅ‰πù", "‰∫åÂçÅ", "Âªø‰∏Ä", "Âªø‰∫å", "Âªø‰∏â", "ÂªøÂõõ", "Âªø‰∫î", "ÂªøÂÖ≠", "Âªø‰∏É", "ÂªøÂÖ´", "Âªø‰πù", "‰∏âÂçÅ"];
        const PALACES = ["ÂëΩÂÆ´", "ÂÖÑÂºü", "Â§´Â¶ª", "Â≠êÂ•≥", "Ë¥¢Â∏õ", "ÁñæÂéÑ", "ËøÅÁßª", "‰∫§Âèã", "ÂÆòÁ¶Ñ", "Áî∞ÂÆÖ", "Á¶èÂæ∑", "Áà∂ÊØç"];
        const TERM_DICT = { 'ÊØîËÇ©': 'ÂêåÊàëËÄÖ‰∏∫ÊØîËÇ©„ÄÇ\n\n‰ª£Ë°®Á´û‰∫â„ÄÅÊúãÂèã„ÄÅÁã¨Á´ãÊÄß„ÄÇ', 'Âä´Ë¥¢': 'ÂêåÊàëËÄåÂºÇÊÄßËÄÖ‰∏∫Âä´Ë¥¢„ÄÇ\n\n‰ª£Ë°®Á†¥Ë¥¢„ÄÅÁ´û‰∫â„ÄÅÊÑüÊÉÖÁî®‰∫ã„ÄÇ', 'È£üÁ•û': 'ÊàëÁîüËÄÖ‰∏∫È£üÁ•û„ÄÇ\n\n‰ª£Ë°®Á¶èÊ∞î„ÄÅÂè£Êâç„ÄÅÊâçÂçé„ÄÅÊ∏©Âíå„ÄÇ', '‰º§ÂÆò': 'ÊàëÁîüËÄåÂºÇÊÄßËÄÖ‰∏∫‰º§ÂÆò„ÄÇ\n\n‰ª£Ë°®ÊâçÂçé„ÄÅÂèõÈÄÜ„ÄÅÂèòÂä®„ÄÅÂÇ≤Ê∞î„ÄÇ', 'Ê≠£Ë¥¢': 'ÊàëÂÖãËÄÖ‰∏∫Ê≠£Ë¥¢„ÄÇ\n\n‰ª£Ë°®Ëñ™ËµÑ„ÄÅÁé∞ÂÆû„ÄÅÁ®≥Èáç„ÄÅÂç†ÊúâÊ¨≤„ÄÇ', 'ÂÅèË¥¢': 'ÊàëÂÖãËÄåÂºÇÊÄßËÄÖ‰∏∫ÂÅèË¥¢„ÄÇ\n\n‰ª£Ë°®Ê®™Ë¥¢„ÄÅÊÖ∑ÊÖ®„ÄÅÊäïÊú∫„ÄÅÂ§öÊÉÖ„ÄÇ', 'Ê≠£ÂÆò': 'ÂÖãÊàëËÄÖ‰∏∫Ê≠£ÂÆò„ÄÇ\n\n‰ª£Ë°®Âú∞‰Ωç„ÄÅÂêçË™â„ÄÅÁ∫™Âæã„ÄÅËá™ÊàëÁ∫¶Êùü„ÄÇ', '‰∏ÉÊùÄ': 'ÂÖãÊàëËÄåÂºÇÊÄßËÄÖ‰∏∫‰∏ÉÊùÄ„ÄÇ\n\n‰ª£Ë°®ÊùÉÂäõ„ÄÅÂéãÂäõ„ÄÅÂãáÊ∞î„ÄÅÁ´û‰∫â„ÄÇ', 'ÂÅèÂç∞': 'ÁîüÊàëËÄÖ‰∏∫ÂÅèÂç∞„ÄÇ\n\n‰ª£Ë°®Áõ¥Ëßâ„ÄÅËâ∫ÊúØ„ÄÅÂ≠§ÂÉª„ÄÅÈ¢ÜÊÇüÂäõ„ÄÇ', 'Ê≠£Âç∞': 'ÁîüÊàëËÄåÂºÇÊÄßËÄÖ‰∏∫Ê≠£Âç∞„ÄÇ\n\n‰ª£Ë°®Â≠¶ËØÜ„ÄÅÊÖàÊÇ≤„ÄÅ‰øùÊä§„ÄÅÂêçË™â„ÄÇ', 'Êó•‰∏ª': 'Âá∫ÁîüÊó•ÁöÑÂ§©Âπ≤Ôºå‰ª£Ë°®ÂëΩ‰∏ªÊú¨‰∫∫„ÄÇ', 'Êµ∑‰∏≠Èáë': 'Ê∑±Ëóè‰∏çÈú≤„ÄÇ\n\n‰ª£Ë°®Âê´ËìÑÊ∑±Ê≤â„ÄÇ', 'ÁÇâ‰∏≠ÁÅ´': 'ÁÉ≠ÁÉàÊó∫Áõõ„ÄÇ\n\n‰ª£Ë°®ÁÉ≠ÊÉÖÊûúÊñ≠„ÄÇ', 'Â§ßÊûóÊú®': 'ÊûùÁπÅÂè∂ËåÇ„ÄÇ\n\n‰ª£Ë°®‰ªÅÊÖàÊ≠£Áõ¥„ÄÇ', 'Ë∑ØÊóÅÂúü': 'Ë∏èÂÆûÂπ≥Á®≥„ÄÇ\n\n‰ª£Ë°®Á®≥ÈáçÂéöÈÅì„ÄÇ', 'ÂâëÈîãÈáë': 'ÈîêÂà©ÂÜ≥Êñ≠„ÄÇ\n\n‰ª£Ë°®ÂàöÂº∫ÈîêÊ∞î„ÄÇ', 'Â±±Â§¥ÁÅ´': 'ÁÅ´ÂäøÊûÅÈ´ò„ÄÇ\n\n‰ª£Ë°®Â®Å‰∏•ÊÄ•Ë∫Å„ÄÇ', 'Ê∂ß‰∏ãÊ∞¥': 'Ê∏ÖÊæàÁªÜÊµÅ„ÄÇ\n\n‰ª£Ë°®ÊüîÂíåËÄêÂøÉ„ÄÇ', 'ÂüéÂ§¥Âúü': 'ÂÆàÂç´‰πãÂúü„ÄÇ\n\n‰ª£Ë°®Âø†ËØö‰øùÂÆà„ÄÇ', 'ÁôΩËú°Èáë': 'Á∫ØÊ¥ÅÊòìÂ°ë„ÄÇ\n\n‰ª£Ë°®ÊüîÂº±ÁÅµÊÄß„ÄÇ', 'Êù®Êü≥Êú®': 'ÈöèÈ£éÊëáÊõ≥„ÄÇ\n\n‰ª£Ë°®ÁÅµÊ¥ªÈÄÇÂ∫î„ÄÇ', 'Ê≥â‰∏≠Ê∞¥': 'Ê∫êÂ§¥Ê¥ªÊ∞¥„ÄÇ\n\n‰ª£Ë°®ÁùøÊô∫Ê∏©Âíå„ÄÇ', 'Â±ã‰∏äÂúü': 'ÈÅÆÈ£éÊå°Èõ®„ÄÇ\n\n‰ª£Ë°®Ë¥£‰ªªÂ≠§Áã¨„ÄÇ', 'ÈúπÈõ≥ÁÅ´': 'ÁàÜÂèëÂ®ÅÁåõ„ÄÇ\n\n‰ª£Ë°®Ê≠£Áõ¥ÁàÜÂèë„ÄÇ', 'ÊùæÊüèÊú®': 'ÂùöÈüß‰∏çÊãî„ÄÇ\n\n‰ª£Ë°®ÈïøÂØøÂ≠§È´ò„ÄÇ', 'ÈïøÊµÅÊ∞¥': 'ÊªîÊªî‰∏çÁªù„ÄÇ\n\n‰ª£Ë°®ËøúËßÅÂ•îÊ≥¢„ÄÇ', 'Ê≤ô‰∏≠Èáë': 'Âéª‰º™Â≠òÁúü„ÄÇ\n\n‰ª£Ë°®ÂùöÈüßÁªÜËá¥„ÄÇ', 'Â±±‰∏ãÁÅ´': 'Ê∏êË∂ãÂπ≥Áºì„ÄÇ\n\n‰ª£Ë°®Ë∞¶ËôöÂÜÖÊïõ„ÄÇ', 'Âπ≥Âú∞Êú®': 'Âπ≥Âéü‰πãÊú®„ÄÇ\n\n‰ª£Ë°®Êú¥ÂÆûÊãÖÂΩì„ÄÇ', 'Â£Å‰∏äÂúü': '‰æùÈôÑ‰æùÈù†„ÄÇ\n\n‰ª£Ë°®Âø†ÂéöËßÑÁü©„ÄÇ', 'ÈáëÁÆîÈáë': 'ÂçéËÄå‰∏çÂÆû„ÄÇ\n\n‰ª£Ë°®ÁªÜËÖªËâ∫ÊúØ„ÄÇ', '‰ΩõÁÅØÁÅ´': 'ÁÖß‰∫ÆÈªëÊöó„ÄÇ\n\n‰ª£Ë°®‰ªÅÊÖàÂ≠§Áã¨„ÄÇ', 'Â§©Ê≤≥Ê∞¥': 'ÊªãÊ∂¶‰∏áÁâ©„ÄÇ\n\n‰ª£Ë°®ÂçöÂ§ßÊÅ©Ê≥Ω„ÄÇ', 'Â§ßÈ©øÂúü': 'Âù¶Ëç°ÂÆΩÈòî„ÄÇ\n\n‰ª£Ë°®ËÉ∏ÊÄÄËØö‰ø°„ÄÇ', 'ÈíóÈíèÈáë': 'Á≤æÂ∑ßÂçé‰∏Ω„ÄÇ\n\n‰ª£Ë°®È´òË¥µÁªÜËÖª„ÄÇ', 'Ê°ëÊüòÊú®': 'Â•âÁåÆÂã§Âä≥„ÄÇ\n\n‰ª£Ë°®ÊüîÈ°∫Â•âÁåÆ„ÄÇ', 'Â§ßÊ∫™Ê∞¥': 'Â•îËÖæ‰∏çÊÅØ„ÄÇ\n\n‰ª£Ë°®Ê¥ªÂäõÈõÑÂøÉ„ÄÇ', 'Ê≤ô‰∏≠Âúü': 'ÊùæÊï£Â§öÂèò„ÄÇ\n\n‰ª£Ë°®ÈöèÂíåÂÆΩÂÆπ„ÄÇ', 'Â§©‰∏äÁÅ´': 'ÂÖâÊòéÁ£äËêΩ„ÄÇ\n\n‰ª£Ë°®ÂçöÂ§ßÂÖ¨Ê≠£„ÄÇ', 'Áü≥Ê¶¥Êú®': 'Â§öÊâçÂ§öËâ∫„ÄÇ\n\n‰ª£Ë°®Â§öÊâçÊÄßÊ†º„ÄÇ', 'Â§ßÊµ∑Ê∞¥': 'Êµ©ÁÄöÊó†Âû†„ÄÇ\n\n‰ª£Ë°®ÂÆΩÂπøÂåÖÂÆπ„ÄÇ' };

        function getWuXingStats(baZi) {
            const counts = { 'wood': 0, 'fire': 0, 'earth': 0, 'metal': 0, 'water': 0 };
            const chars = [baZi.getYearGan(), baZi.getYearZhi(), baZi.getMonthGan(), baZi.getMonthZhi(), baZi.getDayGan(), baZi.getDayZhi(), baZi.getTimeGan(), baZi.getTimeZhi()];
            chars.forEach(c => { if(WUXING[c]) counts[WUXING[c]]++; });
            let result = `${counts.wood}Êú® ${counts.fire}ÁÅ´ ${counts.earth}Âúü ${counts.metal}Èáë ${counts.water}Ê∞¥`;
            const missing = [];
            if(counts.wood === 0) missing.push('Êú®'); if(counts.fire === 0) missing.push('ÁÅ´'); if(counts.earth === 0) missing.push('Âúü'); if(counts.metal === 0) missing.push('Èáë'); if(counts.water === 0) missing.push('Ê∞¥');
            if(missing.length > 0) result += ` ‚ûî [‰∫îË°åÁº∫${missing.join('')}]`;
            return result;
        }

        function getShens(gan, zhi, dGan, yZhi, dZhi) {
            const shens = [];
            const ganBase = {
                'Áî≤': { 'Â§©‰πô': ['‰∏ë', 'Êú™'], 'ÁæäÂàÉ': 'ÂçØ', 'ÊñáÊòå': 'Â∑≥' }, '‰πô': { 'Â§©‰πô': ['Â≠ê', 'Áî≥'], 'ÁæäÂàÉ': 'Ëæ∞', 'ÊñáÊòå': 'Âçà' },
                '‰∏ô': { 'Â§©‰πô': ['‰∫•', 'ÈÖâ'], 'ÁæäÂàÉ': 'Âçà', 'ÊñáÊòå': 'Áî≥' }, '‰∏Å': { 'Â§©‰πô': ['‰∫•', 'ÈÖâ'], 'ÁæäÂàÉ': 'Êú™', 'ÊñáÊòå': 'ÈÖâ' },
                'Êàä': { 'Â§©‰πô': ['‰∏ë', 'Êú™'], 'ÁæäÂàÉ': 'Âçà', 'ÊñáÊòå': 'Áî≥' }, 'Â∑±': { 'Â§©‰πô': ['Â≠ê', 'Áî≥'], 'ÁæäÂàÉ': 'Êú™', 'ÊñáÊòå': 'ÈÖâ' },
                'Â∫ö': { 'Â§©‰πô': ['‰∏ë', 'Êú™'], 'ÁæäÂàÉ': 'ÈÖâ', 'ÊñáÊòå': '‰∫•' }, 'Ëæõ': { 'Â§©‰πô': ['ÂØÖ', 'Âçà'], 'ÁæäÂàÉ': 'Êàå', 'ÊñáÊòå': 'Â≠ê' },
                'Â£¨': { 'Â§©‰πô': ['ÂçØ', 'Â∑≥'], 'ÁæäÂàÉ': 'Â≠ê', 'ÊñáÊòå': 'ÂØÖ' }, 'Áô∏': { 'Â§©‰πô': ['ÂçØ', 'Â∑≥'], 'ÁæäÂàÉ': '‰∏ë', 'ÊñáÊòå': 'ÂçØ' }
            };
            const zhiBase = {
                'Ê°ÉËä±': { 'ÂØÖ': 'ÂçØ', 'Âçà': 'ÂçØ', 'Êàå': 'ÂçØ', 'Áî≥': 'ÈÖâ', 'Â≠ê': 'ÈÖâ', 'Ëæ∞': 'ÈÖâ', 'Â∑≥': 'Âçà', 'ÈÖâ': 'Âçà', '‰∏ë': 'Âçà', '‰∫•': 'Â≠ê', 'ÂçØ': 'Â≠ê', 'Êú™': 'Â≠ê' },
                'È©øÈ©¨': { 'ÂØÖ': 'Áî≥', 'Âçà': 'Áî≥', 'Êàå': 'Áî≥', 'Áî≥': 'ÂØÖ', 'Â≠ê': 'ÂØÖ', 'Ëæ∞': 'ÂØÖ', 'Â∑≥': '‰∫•', 'ÈÖâ': '‰∫•', '‰∏ë': '‰∫•', '‰∫•': 'Â∑≥', 'ÂçØ': 'Â∑≥', 'Êú™': 'Â∑≥' },
                'ÂçéÁõñ': { 'ÂØÖ': 'Êàå', 'Âçà': 'Êàå', 'Êàå': 'Êàå', 'Áî≥': 'Ëæ∞', 'Â≠ê': 'Ëæ∞', 'Ëæ∞': 'Ëæ∞', 'Â∑≥': '‰∏ë', 'ÈÖâ': '‰∏ë', '‰∏ë': '‰∏ë', '‰∫•': 'Êú™', 'ÂçØ': 'Êú™', 'Êú™': 'Êú™' }
            };
            if (ganBase[dGan].Â§©‰πô.includes(zhi)) shens.push('Â§©‰πôË¥µ‰∫∫');
            if (ganBase[dGan].ÁæäÂàÉ === zhi) shens.push('ÁæäÂàÉ');
            if (ganBase[dGan].ÊñáÊòå === zhi) shens.push('ÊñáÊòå');
            if (zhiBase.Ê°ÉËä±[yZhi] === zhi || zhiBase.Ê°ÉËä±[dZhi] === zhi) shens.push('Ê°ÉËä±');
            if (zhiBase.È©øÈ©¨[yZhi] === zhi || zhiBase.È©øÈ©¨[dZhi] === zhi) shens.push('È©øÈ©¨');
            if (zhiBase.ÂçéÁõñ[yZhi] === zhi || zhiBase.ÂçéÁõñ[dZhi] === zhi) shens.push('ÂçéÁõñ');
            return shens;
        }

        const CITY_DATA = { "Âåó‰∫¨Â∏Ç": {"Âåó‰∫¨Â∏Ç": [116.40, 39.90]}, "‰∏äÊµ∑Â∏Ç": {"‰∏äÊµ∑Â∏Ç": [121.47, 31.23]}, "Â§©Ê¥•Â∏Ç": {"Â§©Ê¥•Â∏Ç": [117.20, 39.12]}, "ÈáçÂ∫ÜÂ∏Ç": {"ÈáçÂ∫ÜÂ∏Ç": [106.50, 29.53]}, "Âπø‰∏úÁúÅ": {"ÂπøÂ∑ûÂ∏Ç": [113.23, 23.16], "Ê∑±Âú≥Â∏Ç": [114.07, 22.62], "Áè†Êµ∑Â∏Ç": [113.52, 22.30], "‰∏úËéûÂ∏Ç": [113.75, 23.04], "‰∏≠Â±±Â∏Ç": [113.38, 22.52]}, "ÊµôÊ±üÁúÅ": {"Êù≠Â∑ûÂ∏Ç": [120.19, 30.26], "ÂÆÅÊ≥¢Â∏Ç": [121.56, 29.86], "Ê∏©Â∑ûÂ∏Ç": [120.67, 28.00]}, "Ê±üËãèÁúÅ": {"Âçó‰∫¨Â∏Ç": [118.78, 32.04], "ËãèÂ∑ûÂ∏Ç": [120.62, 31.32], "Êó†Èî°Â∏Ç": [120.29, 31.59]}, "ÂõõÂ∑ùÁúÅ": {"ÊàêÈÉΩÂ∏Ç": [104.06, 30.67]}, "ÂêâÊûóÁúÅ": {"ÈÄöÂåñÂ∏Ç": [125.93, 41.73]} };

        function getEOT(doy) { const b = (2 * Math.PI * (doy - 81)) / 365; return 9.87 * Math.sin(2 * b) - 7.53 * Math.cos(b) - 1.5 * Math.sin(b); }
        function getSolarTimeOffset(lng, y, m, d) {
            const longOff = (lng - 120.0) * 4;
            const date = new Date(y, m - 1, d);
            const start = new Date(y, 0, 0);
            const doy = Math.floor((date - start) / 86400000);
            const eotOff = getEOT(doy);
            return { total: longOff + eotOff, longOff, eotOff };
        }

        function getExactSunSign(solarObj) {
            const zodiacNames = ["Êë©ÁæØ", "Ê∞¥Áì∂", "ÂèåÈ±º", "ÁôΩÁæä", "ÈáëÁâõ", "ÂèåÂ≠ê", "Â∑®Ëüπ", "ÁãÆÂ≠ê", "Â§ÑÂ•≥", "Â§©Áß§", "Â§©Ëùé", "Â∞ÑÊâã"];
            const zhongQiNames = ["ÂÜ¨Ëá≥", "Â§ßÂØí", "Èõ®Ê∞¥", "Êò•ÂàÜ", "Ë∞∑Èõ®", "Â∞èÊª°", "Â§èËá≥", "Â§ßÊöë", "Â§ÑÊöë", "ÁßãÂàÜ", "ÈúúÈôç", "Â∞èÈõ™"];
            const years = [solarObj.getYear() - 1, solarObj.getYear(), solarObj.getYear() + 1];
            let allZhongQi = [];
            years.forEach(y => {
                const l = Lunar.fromYmd(y, 1, 1);
                const table = l.getJieQiTable();
                zhongQiNames.forEach(name => {
                    if (table[name]) allZhongQi.push({ name, jd: table[name].getJulianDay() });
                });
            });
            allZhongQi.sort((a, b) => a.jd - b.jd);
            const currentJd = solarObj.getJulianDay();
            for (let i = 0; i < allZhongQi.length - 1; i++) {
                if (currentJd >= allZhongQi[i].jd && currentJd < allZhongQi[i+1].jd) {
                    const signIndex = zhongQiNames.indexOf(allZhongQi[i].name);
                    const prevZhongQi = allZhongQi[i];
                    const nextZhongQi = allZhongQi[i+1];
                    const diffPrev = (currentJd - prevZhongQi.jd) * 24;
                    const diffNext = (nextZhongQi.jd - currentJd) * 24;
                    let isCusp = false, cuspDetail = "";
                    if (diffPrev < 24) {
                        isCusp = true;
                        cuspDetail = `Ë∑ùÁ¶ª${prevZhongQi.name}ËäÇÊ∞î/ËøõÂÖ•${zodiacNames[signIndex]}Â∫ß‰ªÖ ${diffPrev.toFixed(1)} Â∞èÊó∂„ÄÇ`;
                    } else if (diffNext < 24) {
                        isCusp = true;
                        cuspDetail = `Ë∑ùÁ¶ª${nextZhongQi.name}ËäÇÊ∞î/ËøõÂÖ•${zodiacNames[(signIndex+1)%12]}Â∫ß‰ªÖ ${diffNext.toFixed(1)} Â∞èÊó∂„ÄÇ`;
                    }
                    return { name: zodiacNames[signIndex] + "Â∫ß", isCusp, cuspDetail };
                }
            }
            return { name: solarObj.getXingZuo() + "Â∫ß", isCusp: false, cuspDetail: "" };
        }

        function getAscendant(year, month, day, hh, mm, lng, lat) {
            const date = new Date(Date.UTC(year, month - 1, day, hh, mm));
            const jd = (date.getTime() / 86400000) + 2440587.5;
            const t = (jd - 2451545.0) / 36525.0;
            let gmst = 6.697374558 + 0.06570982441908 * (jd - 2451545.0) + 1.00273790935 * (hh + mm / 60);
            gmst = gmst % 24; if (gmst < 0) gmst += 24;
            let lst = gmst + lng / 15;
            lst = lst % 24; if (lst < 0) lst += 24;
            const ram = lst * 15 * Math.PI / 180;
            const eps = (23.4393 - 0.013 * t) * Math.PI / 180;
            const phi = lat * Math.PI / 180;
            let asc = Math.atan2(Math.cos(ram), -Math.sin(ram) * Math.cos(eps) - Math.tan(phi) * Math.sin(eps));
            asc = asc * 180 / Math.PI; if (asc < 0) asc += 360;
            return ZODIAC_SIGNS[Math.floor(asc / 30)];
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active-grid', 'active-flex');
            });
            const target = document.getElementById('tab-' + tabId);
            if (tabId === 'chart') target.classList.add('active-grid');
            else target.classList.add('active-flex');
            
            document.querySelectorAll('[id^="tabBtn-"]').forEach(b => b.classList.remove('border-yellow-900', 'text-yellow-900'));
            document.querySelectorAll('[id^="tabBtn-"]').forEach(b => b.classList.add('border-transparent', 'text-gray-400'));
            document.getElementById('tabBtn-' + tabId).classList.add('border-yellow-900', 'text-yellow-900');
            document.getElementById('tabBtn-' + tabId).classList.remove('border-transparent', 'text-gray-400');
        }

        window.onload = function() {
            const lastData = JSON.parse(localStorage.getItem('bazi_last_input')) || {};
            const now = new Date();
            const defY = lastData.y || now.getFullYear(), defM = lastData.m || (now.getMonth() + 1), defD = lastData.d || now.getDate();
            const defH = lastData.hh !== undefined ? lastData.hh : now.getHours(), defMin = lastData.mm !== undefined ? lastData.mm : now.getMinutes();
            const defGen = lastData.gender || "1", defUnk = lastData.unknown || false, defCal = lastData.cal || "solar";
            const defProv = lastData.province || "Âåó‰∫¨Â∏Ç", defCity = lastData.city || "Âåó‰∫¨Â∏Ç", defUseSolar = lastData.useSolar || false;

            const yearSel = document.getElementById('inputYear'), monthSel = document.getElementById('inputMonth'), daySel = document.getElementById('inputDay');
            const hourSel = document.getElementById('inputHour'), minSel = document.getElementById('inputMin');
            const unkCheck = document.getElementById('timeUnknown'), provSel = document.getElementById('provinceSel'), citySel = document.getElementById('citySel'), solarCheck = document.getElementById('useSolarTime');

            for(let i=1900; i<=2100; i++) yearSel.add(new Option(i + 'Âπ¥', i, i===defY, i===defY));
            for(let i=0; i<24; i++) hourSel.add(new Option(String(i).padStart(2, '0') + 'Êó∂', i, i===defH, i===defH));
            for(let i=0; i<60; i++) minSel.add(new Option(String(i).padStart(2, '0') + 'ÂàÜ', i, i===defMin, i===defMin));
            Object.keys(CITY_DATA).forEach(p => provSel.add(new Option(p, p, p===defProv, p===defProv)));

            function getCalType() { return document.querySelector('input[name="calType"]:checked').value; }
            function updateCityOptions() { citySel.innerHTML = ''; const p = provSel.value; Object.keys(CITY_DATA[p]).forEach(c => citySel.add(new Option(c, c, c===defCity, c===defCity))); }
            function updateDayOptions() {
                const y = parseInt(yearSel.value), type = getCalType(); monthSel.innerHTML = ''; daySel.innerHTML = '';
                if (type === 'solar') {
                    for(let i=1; i<=12; i++) monthSel.add(new Option(String(i).padStart(2, '0') + 'Êúà', i, i===defM, i===defM));
                    const last = new Date(y, parseInt(monthSel.value), 0).getDate();
                    for(let i=1; i<=last; i++) daySel.add(new Option(String(i).padStart(2, '0') + 'Êó•', i, i===Math.min(defD, last), i===Math.min(defD, last)));
                } else {
                    const months = LunarYear.fromYear(y).getMonths();
                    months.forEach(m => monthSel.add(new Option(m.isLeap() ? "Èó∞" + LUNAR_MONTHS[m.getMonth()-1] : LUNAR_MONTHS[m.getMonth()-1], m.getMonth() * (m.isLeap() ? -1 : 1))));
                    const mVal = parseInt(monthSel.value); const m = months.find(mm => mm.getMonth() === Math.abs(mVal) && mm.isLeap() === (mVal < 0)) || months[0];
                    for(let i=1; i<=m.getDayCount(); i++) daySel.add(new Option(LUNAR_DAYS[i-1], i));
                }
            }

            document.querySelectorAll('input[name="calType"]').forEach(r => r.onchange = () => { updateDayOptions(); updateDisplay(); });
            yearSel.onchange = () => { updateDayOptions(); updateDisplay(); };
            monthSel.onchange = () => { updateDisplay(); };
            daySel.onchange = updateDisplay; hourSel.onchange = updateDisplay; minSel.onchange = updateDisplay;
            provSel.onchange = () => { updateCityOptions(); updateDisplay(); };
            citySel.onchange = updateDisplay; solarCheck.onchange = updateDisplay;
            unkCheck.onchange = () => { document.getElementById('timeInputGroup').style.opacity = unkCheck.checked ? "0.3" : "1"; updateDisplay(); };

            const shichenGrid = document.getElementById('shichenGrid');
            BRANCHES.forEach((b, i) => {
                const btn = document.createElement('button'); btn.innerText = b + 'Êó∂';
                btn.className = "px-2 py-0.5 text-[9px] border border-yellow-300 rounded hover:bg-yellow-100 transition sc-btn";
                btn.onclick = () => { unkCheck.checked = false; hourSel.value = (i * 2 + 23) % 24; minSel.value = 0; updateDisplay(); };
                shichenGrid.appendChild(btn);
            });

            updateCityOptions(); updateDayOptions(); 
            document.querySelector(`input[name="calType"][value="${defCal}"]`).checked = true;
            unkCheck.checked = defUnk; solarCheck.checked = defUseSolar;
            document.getElementById('timeInputGroup').style.opacity = defUnk ? "0.3" : "1";
            document.querySelector(`input[name="gender"][value="${defGen}"]`).checked = true;
            document.getElementById('btnCalculate').onclick = updateDisplay;
            updateDisplay();
        };

        function getWuXingClass(char) { return `color-${WUXING[char] || 'metal'}`; }
        function renderPillar(title, gan, zhi, hide, ssGan, ssZhi, nayin, isDM = false) {
            const tipGan = TERM_DICT[ssGan] || ''; const tipZhi = TERM_DICT[ssZhi] || ''; const tipNaYin = TERM_DICT[nayin] || '';
            return `<div class="flex flex-col items-center ${isDM ? 'pillar-highlight' : ''}">
                    <span class="text-[8px] md:text-[10px] text-red-700 font-bold mb-0.5" ${tipGan ? `data-tip="${ssGan}: ${tipGan}"` : ''}>${ssGan||''}</span>
                    <span class="text-[8px] md:text-[10px] text-yellow-800">${title}</span>
                    <span class="text-base md:text-xl font-bold ${getWuXingClass(gan)}">${gan}</span>
                    <span class="text-base md:text-xl font-bold ${getWuXingClass(zhi)}">${zhi}</span>
                    <div class="flex flex-col items-center leading-none mt-0.5">
                        <span style="color: rgba(44,62,80,0.4)" class="text-[7px] md:text-[9px]">${hide||''}</span>
                        <span style="color: rgba(192,72,81,0.6)" class="text-[7px] md:text-[8px] scale-90" ${tipZhi ? `data-tip="${ssZhi}: ${tipZhi}"` : ''}>${ssZhi||''}</span>
                        <span style="color: rgba(139,69,19,0.5)" class="text-[7px] md:text-[8px] mt-0.5 scale-90 whitespace-nowrap" ${tipNaYin ? `data-tip="${nayin}: ${tipNaYin}"` : ''}>${nayin||''}</span>
                    </div>
                </div>`;
        }

        function updateDisplay() {
            try {
                const y = parseInt(document.getElementById('inputYear').value), m = parseInt(document.getElementById('inputMonth').value), d = parseInt(document.getElementById('inputDay').value);
                const hh = parseInt(document.getElementById('inputHour').value), mm = parseInt(document.getElementById('inputMin').value);
                const type = document.querySelector('input[name="calType"]:checked').value;
                const gen = document.querySelector('input[name="gender"]:checked').value, unk = document.getElementById('timeUnknown').checked;
                const prov = document.getElementById('provinceSel').value, city = document.getElementById('citySel').value, useSolar = document.getElementById('useSolarTime').checked;
                localStorage.setItem('bazi_last_input', JSON.stringify({ y, m, d, hh, mm, gender: gen, unknown: unk, province: prov, city, useSolar, cal: type }));

                let solar;
                if (type === 'solar') solar = Solar.fromYmdHms(y, m, d, hh, mm, 0);
                else { const lunar = Lunar.fromYmd(y, Math.abs(m), d); if (m < 0) lunar.setLeap(true); solar = lunar.getSolar(); solar = Solar.fromYmdHms(solar.getYear(), solar.getMonth(), solar.getDay(), hh, mm, 0); }

                const [lng, lat] = CITY_DATA[prov][city];
                document.getElementById('lngDisplay').innerText = `(${lng},${lat})`;
                const off = getSolarTimeOffset(lng, solar.getYear(), solar.getMonth(), solar.getDay());
                let cSol = solar;
                if (useSolar && !unk) {
                    const cD = new Date(new Date(solar.getYear(), solar.getMonth()-1, solar.getDay(), hh, mm).getTime() + off.total * 60000);
                    cSol = Solar.fromYmdHms(cD.getFullYear(), cD.getMonth()+1, cD.getDate(), cD.getHours(), cD.getMinutes(), 0);
                }
                const lunar = Lunar.fromSolar(cSol), baZi = lunar.getEightChar();
                const yun = baZi.getYun(gen === '1' ? 1 : 0);
                const startSolar = yun.getStartSolar();
                const dayuns = yun.getDaYun();
                const wxStats = getWuXingStats(baZi);
                const taiYuan = baZi.getTaiYuan();
                const mingGong = baZi.getMingGong();
                const shenGong = baZi.getShenGong();
                const dayKong = baZi.getDayXunKong();
                const yearKong = baZi.getYearXunKong();

                const shensN = getShens(baZi.getYearGan(), baZi.getYearZhi(), baZi.getDayGan(), baZi.getYearZhi(), baZi.getDayZhi());
                const shensY = getShens(baZi.getMonthGan(), baZi.getMonthZhi(), baZi.getDayGan(), baZi.getYearZhi(), baZi.getDayZhi());
                const shensR = getShens(baZi.getDayGan(), baZi.getDayZhi(), baZi.getDayGan(), baZi.getYearZhi(), baZi.getDayZhi());
                const shensS = unk ? [] : getShens(baZi.getTimeGan(), baZi.getTimeZhi(), baZi.getDayGan(), baZi.getYearZhi(), baZi.getDayZhi());

                const mgBranch = mingGong[1];
                const mgIdx = BRANCHES.indexOf(mgBranch);
                const palaceMap = {};
                for (let i = 0; i < 12; i++) {
                    const branchIdx = (mgIdx - i + 12) % 12;
                    palaceMap[BRANCHES[branchIdx]] = PALACES[i];
                }

                const asc = unk ? "?" : getAscendant(cSol.getYear(), cSol.getMonth(), cSol.getDay(), cSol.getHour(), cSol.getMinute(), lng, lat);
                const sunSignData = getExactSunSign(cSol);

                if (!unk) {
                    let st = cSol.getHour() % 2 === 0 ? cSol.getHour() - 1 : cSol.getHour(); if (st === -1) st = 23;
                    document.getElementById('shichenInfo').innerHTML = `Êó∂Ëæ∞:${String(st).padStart(2, '0')}:00~${String((st+2)%24).padStart(2, '0')}:00 | ‰øÆÊ≠£:${off.total.toFixed(1)}ÂàÜ`;
                    document.querySelectorAll('.sc-btn').forEach(btn => btn.innerText.startsWith(baZi.getTimeZhi()) ? btn.classList.add('bg-yellow-700', 'text-white') : btn.classList.remove('bg-yellow-700', 'text-white'));
                } else { document.getElementById('shichenInfo').innerText = "Âá∫ÁîüÊó∂Ëæ∞‰∏çËØ¶"; }

                document.getElementById('basicInfo').innerHTML = `<div class="text-[12px] md:text-[13px] font-bold">${cSol.toYmd()} ${unk ? '' : String(cSol.getHour()).padStart(2, '0')+':'+String(cSol.getMinute()).padStart(2, '0')}</div><div class="text-[10px] md:text-[11px] text-yellow-900">${lunar.getMonthInChinese()}Êúà ${lunar.getDayInChinese()} ${unk ? '' : '('+baZi.getTimeZhi()+'Êó∂)'}</div><div class="flex flex-wrap justify-center gap-x-1 text-[8px] md:text-[9px] mt-0.5 opacity-80"><span>${lunar.getYearShengXiao()}</span><span class="cursor-help" data-tip="Â§™Èò≥ÊòüÂ∫ßÔºö‰ª£Ë°®‰∏Ä‰∏™‰∫∫ÁöÑÂü∫Êú¨ÊÄßÊ†º„ÄÇ${sunSignData.isCusp ? '\n‚ö†Ô∏è' + sunSignData.cuspDetail : ''}">${sunSignData.name}${sunSignData.isCusp ? '*' : ''}</span><span class="text-red-800 font-bold cursor-help" data-tip="‰∏äÂçáÊòüÂ∫ßÔºö‰ª£Ë°®Áªô‰∫∫ÁöÑÁ¨¨‰∏ÄÂç∞Ë±°„ÄÇ">(${asc}Â∫ß)</span></div>`;
                document.getElementById('baziDisplay').innerHTML = `${renderPillar('Âπ¥', baZi.getYearGan(), baZi.getYearZhi(), baZi.getYearHideGan().join(''), baZi.getYearShiShenGan(), baZi.getYearShiShenZhi()[0], lunar.getYearNaYin())}${renderPillar('Êúà', baZi.getMonthGan(), baZi.getMonthZhi(), baZi.getMonthHideGan().join(''), baZi.getMonthShiShenGan(), baZi.getMonthShiShenZhi()[0], lunar.getMonthNaYin())}${renderPillar('Êó•', baZi.getDayGan(), baZi.getDayZhi(), baZi.getDayHideGan().join(''), 'Êó•‰∏ª', baZi.getDayShiShenZhi()[0], lunar.getDayNaYin(), true)}${unk ? '<div class="flex flex-col items-center opacity-20"><span class="text-[9px] text-yellow-800">Êó∂</span><span class="text-xl font-bold text-gray-300">?</span></div>' : renderPillar('Êó∂', baZi.getTimeGan(), baZi.getTimeZhi(), baZi.getTimeHideGan().join(''), baZi.getTimeShiShenGan(), baZi.getTimeShiShenZhi()[0], lunar.getTimeNaYin())}`;

                BRANCHES.forEach((branch, index) => {
                    const cell = document.getElementById(`pos-${index}`);
                    const isT = !unk && baZi.getTimeZhi() === branch, isY = baZi.getYearZhi() === branch;
                    const pName = palaceMap[branch];
                    cell.innerHTML = `<div class="flex justify-between items-start"><span class="text-base font-bold ${getWuXingClass(branch)}">${branch}</span><div class="flex flex-col items-end">${isT?'<span class="bg-red-700 text-white text-[7px] px-0.5 rounded">Êó∂</span>':''}${isY?'<span class="bg-yellow-700 text-white text-[7px] px-0.5 rounded">Âπ¥</span>':''}</div></div><div class="text-[9px] md:text-[10px] text-yellow-900 text-right mt-auto">${pName}</div>`;
                    cell.style.backgroundColor = isT ? "rgba(254, 243, 199, 0.8)" : "";
                    if (pName === 'ÂëΩÂÆ´') cell.classList.add('ring-1', 'ring-red-300');
                    else cell.classList.remove('ring-1', 'ring-red-300');
                });

                let mdText = `### ÈóÆÂ§©ÊòüÁÆóÊéíÁõòÊä•Âëä\n\n- **ÂÖ¨ÂéÜ**: ${cSol.toYmd()} ${unk ? '‰∏çËØ¶' : String(cSol.getHour()).padStart(2, '0')+':'+String(cSol.getMinute()).padStart(2, '0')}\n- **Âú∞ÁÇπ**: ${prov}-${city} (${lng}, ${lat})\n- **ÂÜúÂéÜ**: ${lunar.getYearInChinese()}Âπ¥ ${lunar.getMonthInChinese()}Êúà ${lunar.getDayInChinese()}\n- **${unk?'ÂÖ≠Â≠ó':'ÂÖ´Â≠ó'}**: ${baZi.getYearGan()}${baZi.getYearZhi()}Âπ¥ ${baZi.getMonthGan()}${baZi.getMonthZhi()}Êúà ${baZi.getDayGan()}${baZi.getDayZhi()}Êó•${unk?'':' '+baZi.getTimeGan()+baZi.getTimeZhi()+'Êó∂'}\n- **ÁúüÂ§™Èò≥Êó∂‰øÆÊ≠£**: ${off.total.toFixed(2)} ÂàÜÈíü\n- **ÊÄßÂà´**: ${gen==='1'?'Áî∑':'Â•≥'} / **ÁîüËÇñ**: ${lunar.getYearShengXiao()} (${lunar.getYearNaYin()})\n\n### üåå Âç†ÊòüÂ≠¶Ê†∏ÂøÉÈÖçÁΩÆ (Â§©ÊñáÁ∫ßÈ´òÁ≤æÂ∫¶Ê†°ÂáÜ)\n- **Á≤æÂáÜÂ§™Èò≥ÊòüÂ∫ß**: ${sunSignData.name} ${sunSignData.isCusp ? '\n  *(‚ö†Ô∏è Á≥ªÁªüÊèêÁ§∫ÔºöÈ´òÁ≤æÂ∫¶Â§©ÊñáËÆ°ÁÆóÂà§ÂÆö„ÄÇÂëΩ‰∏ªÂá∫Áîü‰∫é‰∫§ÁïåÊó•Ôºå' + sunSignData.cuspDetail + 'Â±ûÂÖ∏ÂûãÁöÑ‚ÄúËæπÁïåÊòüÂ∫ß Cusp‚Äù„ÄÇËØ∑Âú®ÂêéÁª≠ÊÄßÊ†º‰∏éËøêÂäøËß£Êûê‰∏≠ÔºåÈáçÁÇπËûçÂêàËØ•‰∏§ÊòüÂ∫ßÁöÑÂèåÈáçÁâπË¥®ËøõË°åÊ∑±Â∫¶Ëß£ËØª„ÄÇ)*' : ''}\n- **Á≤æÂáÜ‰∏äÂçáÊòüÂ∫ß**: ${asc}Â∫ß \n  *(Âü∫‰∫éÂú∞ÁêÜÂùêÊ†áÔºöÁªèÂ∫¶ ${lng}¬∞E, Á∫¨Â∫¶ ${lat}¬∞NÔºåÁªìÂêàÂú∞ÊñπÊÅíÊòüÊó∂Á≤æÁ°ÆÊé®ÂØº)*\n\n#### ÁîüËæ∞ÂÖ´Â≠ó (${unk?'ÂÖ≠Â≠ó' : 'ÂÖ´Â≠ó'})\n| ÂõõÊü± | Âπ¥Êü± | ÊúàÊü± | Êó•Êü± | Êó∂Êü± |\n| :--- | :--- | :--- | :--- | :--- |\n| **ÂçÅÁ•û** | ${baZi.getYearShiShenGan()} | ${baZi.getMonthShiShenGan()} | Êó•‰∏ª | ${unk?'?':baZi.getTimeShiShenGan()} |\n| **Âπ≤ÊîØ** | ${baZi.getYearGan()}${baZi.getYearZhi()} | ${baZi.getMonthGan()}${baZi.getMonthZhi()} | ${baZi.getDayGan()}${baZi.getDayZhi()} | ${unk?'??':baZi.getTimeGan()+baZi.getTimeZhi()} |\n| **Âú∞Âäø** | ${baZi.getYearShiShenZhi()[0]} | ${baZi.getMonthShiShenZhi()[0]} | ${baZi.getDayShiShenZhi()[0]} | ${unk?'?':baZi.getTimeShiShenZhi()[0]} |\n| **Á∫≥Èü≥** | ${lunar.getYearNaYin()} | ${lunar.getMonthNaYin()} | ${lunar.getDayNaYin()} | ${unk?'?':lunar.getTimeNaYin()} |\n| **ËóèÂπ≤** | ${baZi.getYearHideGan().join('')} | ${baZi.getMonthHideGan().join('')} | ${baZi.getDayHideGan().join('')} | ${unk?'?':baZi.getTimeHideGan().join('')} |\n\n### üìä ÂëΩÂ±Ä‰∫îË°å‰∏éÂü∫Á°ÄÂèÇÊï∞\n- **‰∫îË°åÁªüËÆ°**Ôºö${wxStats}\n- **Á©∫‰∫°**ÔºöÊó•Á©∫[${dayKong}] | Âπ¥Á©∫[${yearKong}]\n- **‰∏âÂû£**ÔºöËÉéÂÖÉ[${taiYuan}] | ÂëΩÂÆ´[${mingGong}] | Ë∫´ÂÆ´[${shenGong}]\n\n### üåü ÂõõÊü±Á•ûÁÖû (Ëß£ÁõòÂÖ≥ÈîÆÂèñË±°)\n- **Âπ¥Êü±** (${baZi.getYearGan()}${baZi.getYearZhi()}): [${shensN.join(', ') || 'Êó†'}]\n- **ÊúàÊü±** (${baZi.getMonthGan()}${baZi.getMonthZhi()}): [${shensY.join(', ') || 'Êó†'}]\n- **Êó•Êü±** (${baZi.getDayGan()}${baZi.getDayZhi()}): [${shensR.join(', ') || 'Êó†'}]\n- **Êó∂Êü±** (${unk?'??' : baZi.getTimeGan()+baZi.getTimeZhi()}): [${shensS.join(', ') || 'Êó†'}]\n\n### ‚è≥ ÂëΩËøêËΩ®Ëøπ (Â§ßËøêËµ∞Âäø)\n**‰∫§ËøêÊó∂Èó¥**: Âá∫ÁîüÂêé ${yun.getStartYear()} Âπ¥ ${yun.getStartMonth()} ‰∏™Êúà ${yun.getStartDay()} Â§©‰∫§Ëøê (ÂÖ¨ÂéÜ ${startSolar.toYmd()} Ëµ∑Ëøê)\n| Ê≠•Êï∞ | ËôöÂ≤Å | Ëµ∑ËøêÂπ¥‰ªΩ | Â§ßËøêÂπ≤ÊîØ |\n| --- | --- | --- | --- |\n`;
                
                dayuns.slice(1, 9).forEach((dy, i) => {
                    mdText += `| ${i+1} | ${dy.getStartAge()}Â≤Å | ${dy.getStartYear()} | ${dy.getGanZhi()} |\n`;
                });

                mdText += `\n### üåå ÂçÅ‰∫åÂÆ´‰ΩçÂàÜÂ∏É\n`;
                const pList = BRANCHES.map(b => `- **${b}ÂÆ´**: ${palaceMap[b]}ÂÆ´`).join(' | ');
                mdText += pList + `\n\n---\n*Êä•ÂëäÁî±ÈóÆÂ§©ÊòüÁÆóÁîüÊàêÔºå${useSolar?'Â∑≤Â∫îÁî®ÁúüÂ§™Èò≥Êó∂‰øÆÊ≠£':'Êú™Â∫îÁî®‰øÆÊ≠£'}*`;

                document.getElementById('mdOutput').value = mdText;
            } catch (e) { console.error(e); }
        }
        function copyMd() { const area = document.getElementById('mdOutput'); const btn = document.getElementById('copyBtn'); area.select(); document.execCommand('copy'); btn.innerText = 'Â∑≤Â§çÂà∂'; setTimeout(() => { btn.innerText = 'Â§çÂà∂'; }, 1500); }
    </script>
</body>
</html>
